<html layout:decorate="~{Layout/layout_main}" xmlns:th="http://www.thymeleaf.org">
<head>
    <link rel="stylesheet" type="text/css" th:href="@{/dm/css/DirectInbox.css}">
    <title>User Page</title>
</head>
<div layout:fragment="content">
    <div class="d-flex">
        <div class="main-content d-flex" style="margin-left: 4.5rem;">
            <div class="col-3" style="width: 398px; overflow-y: scroll">
                <ul>
                    <li th:each="dto:${roomList}">
                        <a th:href="@{|/direct/t/${dto.room.id}|}"
                           th:text="${dto.name}"></a>
                    </li>
                </ul>
            </div>
            <div class="flex-fill">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <div>
                    <div class="d-flex align-items-center border-bottom" style="height: 75px; min-height: 75px; padding: 0 16px">
                        <div th:each="member : ${nowRoomDTO.members}">
                            <a th:href="@{|/member/page/${member.getValue().username}|}">
                                <div th:if="${member.getKey() != loginMember.username}"
                                     style="position: relative; width: 44px; height: 44px; margin: 6px">
                                    <img th:if="${member.getValue().image == null}"
                                         src="/files/designImg/noneuser.png"
                                         class="shadow-sm rounded-circle text-center"
                                         style="position: absolute; top: 0; left: 0; transform: translate(50,50); width: 100%; height: 100%; object-fit: cover; margin: auto">
                                    <img th:unless="${member.getValue().image == null}"
                                         th:src="@{|/resources/${member.getValue().image.name}|}"
                                         class="shadow-sm rounded-circle text-center"
                                         style="position: absolute; top: 0; left: 0; transform: translate(50,50); width: 100%; height: 100%; object-fit: cover; margin: auto">
                                </div>
                            </a>
                        </div>
                        <span style="padding: 6px; font-size: 16px;" class="fw-bold" th:text="${nowRoomDTO.name}"></span>
                    </div>
                    <input type="hidden" id="room-id" th:value="${nowRoomDTO.room.id}">
                    <input type="hidden" id="loginUser-username" th:value="${loginMember.username}">
                </div>
                <div class="d-flex justify-content-center align-items-center" style="height: calc(100vh - 75px - 78px);">
                    <div class="w-100 h-100 d-flex align-items-center justify-content-center" id="spin-container">
                        <span class="spinner-border">

                        </span>
                    </div>
                    <div id="msg-container" class="w-100 h-100" style="overflow-y: scroll; display: none;">
                        <div class="msgArea">
                            <div th:each="msg, iterStat : ${messageList}">
                                <div th:id="'msg'+${msg.id}" th:if="${msg.member.username == loginMember.username}" class="px-4 pt-1">
                                    <div class="d-flex justify-content-end">
                                        <div class="d-flex align-items-center" style="margin-right: 5px">
                                            <div style="margin: 8px; color: #9f9f9f">
                                                <button th:id="${msg.id}" type="button" class="btn" data-bs-container="body" data-bs-toggle="popover" data-bs-placement="top" data-bs-target="popover" data-bs-html="true">
                                                    <svg aria-label="더 보기" fill="currentColor" height="16" role="img" viewBox="0 0 24 24" width="16"><title>더 보기</title><circle cx="12" cy="12" r="1.5"></circle><circle cx="6" cy="12" r="1.5"></circle><circle cx="18" cy="12" r="1.5"></circle></svg>
                                                </button>
                                            </div>

                                            <div style="margin: 8px; color: #9f9f9f">
                                                <svg aria-label="답장" fill="currentColor" height="16" role="img" viewBox="0 0 24 24" width="16"><title>답장</title><path d="M14 8.999H4.413l5.294-5.292a1 1 0 1 0-1.414-1.414l-7 6.998c-.014.014-.019.033-.032.048A.933.933 0 0 0 1 9.998V10c0 .027.013.05.015.076a.907.907 0 0 0 .282.634l6.996 6.998a1 1 0 0 0 1.414-1.414L4.415 11H14a7.008 7.008 0 0 1 7 7v3.006a1 1 0 0 0 2 0V18a9.01 9.01 0 0 0-9-9Z"></path></svg>
                                            </div>
                                            <div style="margin: 8px; color: #9f9f9f">
                                                <svg aria-label="공감" fill="currentColor" height="16" role="img" viewBox="0 0 24 24" width="16"><title>공감</title><path d="M15.83 10.997a1.167 1.167 0 1 0 1.167 1.167 1.167 1.167 0 0 0-1.167-1.167Zm-6.5 1.167a1.167 1.167 0 1 0-1.166 1.167 1.167 1.167 0 0 0 1.166-1.167Zm5.163 3.24a3.406 3.406 0 0 1-4.982.007 1 1 0 1 0-1.557 1.256 5.397 5.397 0 0 0 8.09 0 1 1 0 0 0-1.55-1.263ZM12 .503a11.5 11.5 0 1 0 11.5 11.5A11.513 11.513 0 0 0 12 .503Zm0 21a9.5 9.5 0 1 1 9.5-9.5 9.51 9.51 0 0 1-9.5 9.5Z"></path></svg>
                                            </div>
                                        </div>
                                        <div>
                                            <div class="d-flex align-items-center justify-content-end my-2">
                                                <div th:if="${msg.dataType == 1}" class="rounded-5 bg-primary text-light p-2 px-3"
                                                     th:text="${msg.message.content}">
                                                </div>
                                                <div th:if="${msg.dataType == 2}">
                                                    <img th:src="@{|/resources/${msg.image.name}|}"
                                                        style="width: 15rem; height: auto; border-radius: 22px 4px 22px 22px">
                                                </div>
                                                <div th:if="${msg.dataType == 3}" class="d-flex justify-content-end position-relative">
                                                    <span style="position: absolute;">
                                                        <img height="45" width="45" alt="" src="/files/designImg/playButton.png">
                                                    </span>
                                                    <video style="width: 15rem; height: auto; border-radius: 22px 4px 22px 22px"
                                                           th:src="@{|/resources/${msg.video.name}|}">
                                                    </video>
                                                </div>
                                            </div>
                                            <div th:classappend="${iterStat.last}?'read-check'" class="my-2 text-end" th:text="${iterStat.last}?${msg.seeMember}:''"></div>
                                        </div>
                                    </div>
                                </div>
                                <div th:unless="${msg.member.username == loginMember.username}" class="px-4 pt-1">
                                    <div class="my-2" th:text="${msg.member.username}"></div>
                                    <div class="d-flex my-2" th:classappend="${msg.dataType == 1}?'align-items-center'">
                                        <a th:href="@{|/member/page/${msg.member.username}|}">
                                            <div style="position: relative; width: 3rem; height: 3rem;">
                                                <img th:if="${msg.member.image == null}"
                                                     src="/files/designImg/noneuser.png"
                                                     class="shadow-sm rounded-circle text-center"
                                                     style="position: absolute; top: 0; left: 0; transform: translate(50,50); width: 100%; height: 100%; object-fit: cover; margin: auto">
                                                <img th:unless="${msg.member.image == null}"
                                                     th:src="@{|/resources/${msg.member.image.name}|}"
                                                     class="shadow-sm rounded-circle text-center"
                                                     style="position: absolute; top: 0; left: 0; transform: translate(50,50); width: 100%; height: 100%; object-fit: cover; margin: auto">
                                            </div>
                                        </a>
                                        <div th:if="${msg.dataType == 1}" class="mx-3 rounded-5 bg-primary text-light p-2 px-3"
                                             th:text="${msg.message.content}">
                                        </div>
                                        <div th:if="${msg.dataType == 2}" class="mx-3">
                                            <img th:src="@{|/resources/${msg.image.name}|}"
                                                 style="width: 15rem; height: auto; border-radius: 4px 22px 22px 22px">
                                        </div>
                                        <div th:if="${msg.dataType == 3}" class="mx-3 d-flex justify-content-end position-relative">
                                            <span style="position: absolute;">
                                                <img height="45" width="45" alt="" src="/files/designImg/playButton.png">
                                            </span>
                                            <video style="width: 15rem; height: auto; border-radius: 4px 22px 22px 22px"
                                                   th:src="@{|/resources/${msg.video.name}|}">
                                            </video>
                                        </div>

                                        <div class="flex-fill">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="d-flex align-items-center" style="height: 78px; min-height: 78px">
                    <div class="d-flex w-100 px-4 pe-5">
                        <div class="me-2 flex-fill">
                            <input type="text" placeholder="보낼 메세지를 입력하세요."
                                   class="content form-control" oninput="inputMessage(this)" onkeydown="inputEnter(event)">
                        </div>
                        <div class="me-2">
                            <button type="button" value="전송" id="send-btn" disabled
                                    class="sendBtn btn btn-primary" onclick="sendMsg(this)">전송</button>
                        </div>
                        <div>
                            <button type="button" value="파일" class="quit btn btn-primary" onclick="clickFile()">파일</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <input type="file" accept="image/jpeg, image/png, video/mp4" class="visually-hidden"
               id="file-sender" multiple
               name="file-sender" onchange="directFile(this);">
    </div>

    <script th:inline="javascript">

        let popoverTriggerList = document.querySelectorAll('[data-bs-toggle="popover"]');
        let popoverList = [...popoverTriggerList].map(popoverTriggerEl => new bootstrap.Popover(popoverTriggerEl));

        for(var z = 0; z < popoverList.length; z++)
        {
            var dynamicContent = '<div><div id="' + popoverTriggerList.item(z).id + '" class="delete-msg">전송 취소</div></div>';
            popoverTriggerList.item(z).setAttribute('data-bs-content', dynamicContent);
        }

        deleteMsgTrigger();

        function popoverChange()
        {
            debugger;

            const a = document.querySelectorAll('[data-bs-toggle="popover"]');
            var d= a.length-1;
            const newPopoverTriggerList = document.querySelectorAll('[data-bs-toggle="popover"]').item(d);
            const newPopoverList = [newPopoverTriggerList].map(popoverTriggerEl => new bootstrap.Popover(popoverTriggerEl));

            popoverList.push(newPopoverList);

            var dynamicContent = '<div><div id="' + newPopoverTriggerList.id + '" class="delete-msg">전송 취소</div></div>';
            newPopoverTriggerList.setAttribute('data-bs-content', dynamicContent);
        }

        function deleteMsgTrigger()
        {
            $(document).on('click', '.delete-msg', function() {
            // 삭제 동작 수행
            alert("메시지 삭제");
            debugger;

            var msgID = $(this).attr('id');
            // Popover 닫기 (선택 사항)
            deleteMsg(msgID);
            });
        }

        var sideCheck = document.getElementById('expand-direct-menu');
        sideCheck.checked = true;

        var sidebar = document.getElementById('side_bar');
        sidebar.style.width = '4.5rem';

        var sidemenu = document.getElementById('side_menu');
        sidemenu.style.width = '4.5rem';

        setTimeout(() => {

            document.getElementById('spin-container').remove();
            document.getElementById("msg-container").style.display='inline';
            scrollEnd();
        }, 1200);

        var roomId = document.getElementById('room-id').value;
        var username = document.getElementById('loginUser-username').value;
        let msgArea = document.querySelector('.msgArea');
        var connectMember = [];

        function inputMessage(input)
        {
            var sendBtn = document.getElementById('send-btn');
            sendBtn.disabled = input.value === '';
        }

        function inputEnter(event)
        {
            var sendBtn = document.getElementById('send-btn');
            if(event.key === 'Enter')
            {
                
                if(!sendBtn.disabled)
                {
                    sendBtn.click();
                }
            }
        }

        function enterRoom(socket) {

            var enterMsg =
                {
                    "type": "ENTER",
                    "roomId": roomId,
                    "sender": username,
                };

            socket.send(JSON.stringify(enterMsg));

            const csrfToken = document.querySelector('input[name="_csrf"]').value;
            fetch('/direct/quit',
                {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': csrfToken
                    },
                    body: JSON.stringify(enterMsg)
                })
        }

        let socket = new WebSocket("ws://localhost:8888/ws/chat");

        socket.onopen = function (e) {

            console.log('open server!')
            enterRoom(socket);
        };

        socket.onclose = function (e) {
            console.log('disconnet');
        }

        socket.onerror = function (e) {

            console.log(e);
        }

        //메세지 수신했을 때 이벤트.
        socket.onmessage = function (e) {

            const csrfToken = document.querySelector('input[name="_csrf"]').value;

            console.log(e.data);

            var data = JSON.parse(e.data);
            if (data.type === 'TALK' && data.sender === username) {
                createMineMessage(data);
            } else if (data.type === 'TALK' && data.sender !== username) {
                createMessage(data);

                setTimeout(()=>{
                    fetch('/direct/readMessage',
                        {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRF-TOKEN': csrfToken
                            },
                            body: JSON.stringify(data)
                        });
                }, 100);

            } else if (data.type === 'ENTER' && data.sender !== username) {
                sendConnectState(socket);

                connectMember.push(data.sender);

                readMessage(data);
            } else if (data.type === 'CONNECT' && data.sender !== username) {
                connectMember.push(data.sender);
            } else if (data.type === 'DISCONNECT' && data.sender !== username) {
                let index = connectMember.indexOf(data.sender);
                if (index !== -1) {
                    connectMember.splice(index, 1);
                }
            }

        }

        function sendConnectState(socket) {

            var enterMsg =
                {
                    "type": "CONNECT",
                    "roomId": roomId,
                    "sender": username,
                };

            socket.send(JSON.stringify(enterMsg));
        }

        function readMessage(data) {
            var readCheck = document.getElementsByClassName('read-check');

            for (var i = 0; i < readCheck.length; i++) {
                readCheck.item(i).textContent = data.sender + '님이 확인함';
            }
            scrollEnd();
        }

        function createMineMessage(data) {

            var readCheck = document.getElementsByClassName('read-check');

            for (var j = 0; j < readCheck.length; j++) {
                readCheck.item(j).textContent = '';
                readCheck.item(j).classList.remove('read-check');
            }

            var read = '';
            for (var i = 0; i < connectMember.length; i++) {
                read += connectMember[i] + '님';
                if (i !== connectMember.length - 1) {
                    read += ',';
                } else {
                    read += '이 확인함';
                }
            }

            var msgStr = '';
            if(data.dataType === 1)
            {
                msgStr =
                    '<div class="rounded-5 bg-primary text-light p-2 px-3">\n' +
                        data.msg +
                    '</div>\n';
            }
            else if(data.dataType === 2)
            {
                msgStr =
                    '<div>\n' +
                    '    <img src="/resources/'+ data.msg + '" style="width: 15rem; height: auto; border-radius: 22px 4px 22px 22px">\n' +
                    '</div>';
            }
            else if(data.dataType === 3)
            {
                msgStr =
                    '<div class="d-flex justify-content-end position-relative">\n' +
                    '       <span style="position: absolute;">\n' +
                    '             <img height="45" width="45" alt="" src="/files/designImg/playButton.png">\n' +
                    '       </span>'+
                    '       <video style="width: 15rem; height: auto; border-radius: 22px 4px 22px 22px" src="/resources/'+ data.msg + '">\n' +
                    '       </video>'+
                    '</div>';
            }


            let newMsg = document.createElement('div');
            newMsg.innerHTML =
                '                           <div id="msg-' + data.id +'" class="px-4 pt-1">\n' +
                '                                <div class="d-flex justify-content-end">\n' +
                '                                       <div class="d-flex align-items-center" style="margin-right: 5px">\n' +
                '                                            <div style="margin: 8px; color: #9f9f9f">\n' +
                '                                                <button id="'+data.id+'" type="button" class="btn" data-bs-container="body" data-bs-toggle="popover" data-bs-placement="top" data-bs-target="popover" data-bs-html="true">\n' +
                '                                                    <svg aria-label="더 보기" fill="currentColor" height="16" role="img" viewBox="0 0 24 24" width="16"><title>더 보기</title><circle cx="12" cy="12" r="1.5"></circle><circle cx="6" cy="12" r="1.5"></circle><circle cx="18" cy="12" r="1.5"></circle></svg>\n' +
                '                                                </button>\n' +
                '                                            </div>\n' +
                '                                            <div style="margin: 8px; color: #9f9f9f">\n' +
                '                                                <svg aria-label="답장" fill="currentColor" height="16" role="img" viewBox="0 0 24 24" width="16"><title>답장</title><path d="M14 8.999H4.413l5.294-5.292a1 1 0 1 0-1.414-1.414l-7 6.998c-.014.014-.019.033-.032.048A.933.933 0 0 0 1 9.998V10c0 .027.013.05.015.076a.907.907 0 0 0 .282.634l6.996 6.998a1 1 0 0 0 1.414-1.414L4.415 11H14a7.008 7.008 0 0 1 7 7v3.006a1 1 0 0 0 2 0V18a9.01 9.01 0 0 0-9-9Z"></path></svg>\n' +
                '                                            </div>\n' +
                '                                            <div style="margin: 8px; color: #9f9f9f">\n' +
                '                                                <svg aria-label="공감" fill="currentColor" height="16" role="img" viewBox="0 0 24 24" width="16"><title>공감</title><path d="M15.83 10.997a1.167 1.167 0 1 0 1.167 1.167 1.167 1.167 0 0 0-1.167-1.167Zm-6.5 1.167a1.167 1.167 0 1 0-1.166 1.167 1.167 1.167 0 0 0 1.166-1.167Zm5.163 3.24a3.406 3.406 0 0 1-4.982.007 1 1 0 1 0-1.557 1.256 5.397 5.397 0 0 0 8.09 0 1 1 0 0 0-1.55-1.263ZM12 .503a11.5 11.5 0 1 0 11.5 11.5A11.513 11.513 0 0 0 12 .503Zm0 21a9.5 9.5 0 1 1 9.5-9.5 9.51 9.51 0 0 1-9.5 9.5Z"></path></svg>\n' +
                '                                            </div>\n' +
                '                                        </div>'+
                '                                    <div>\n' +
                '                                        <div class="d-flex align-items-center justify-content-end my-2">\n' +
                                                            msgStr +
                '                                        </div>\n' +
                '                                        <div class="read-check my-2 text-end">\n' +
                                                            read +
                '                                        </div>\n' +
                '                                    </div>\n' +
                '                                </div>\n' +
                '                            </div>';

            msgArea.appendChild(newMsg);

            popoverChange();

            setTimeout(scrollEnd, 100);
        }

        function scrollEnd()
        {
        
            var objDiv = document.getElementById("msg-container");
            objDiv.scrollTop = objDiv.scrollHeight;
        }


        function createMessage(data) {

            let newMsg = document.createElement('div');

            var members = [[${nowRoomDTO.members}]];
            var imgSrc = '';
            var img = members[data.sender].image;
            if (img === null) {
                imgSrc = 'src="/files/designImg/noneuser.png"\n';
            } else {
                imgSrc = 'src="/resources/' + img.name + '"\n';
            }


            var msgStr = '';
            var align = '';
            if(data.dataType === 1)
            {
                msgStr =
                    '<div class="mx-3 rounded-5 bg-primary text-light p-2 px-3" style="background: #b7b7b7">\n' +
                        data.msg +
                    '</div>\n';

                align = 'align-items-center';
            }
            else if(data.dataType === 2)
            {
                msgStr =
                    '<div class="mx-3">\n' +
                    '    <img src="/resources/'+ data.msg + '" style="width: 15rem; height: auto; border-radius: 4px 22px 22px 22px">\n' +
                    '</div>';
            }
            else if(data.dataType === 3)
            {
                msgStr =
                    '<div class="mx-3 d-flex justify-content-end position-relative">' +
                    '       <span style="position: absolute;">\n' +
                    '             <img height="45" width="45" alt="" src="/files/designImg/playButton.png">\n' +
                    '       </span>'+
                    '       <video style="width: 15rem; height: auto; border-radius: 22px 4px 22px 22px" src="/resources/'+ data.msg + '">\n' +
                    '       </video>'+
                    '</div>';
            }

            newMsg.innerHTML =
                '                            <div class="px-4 pt-1">\n' +
                '                                <div class="my-2">\n' +
                data.sender +
                '                                </div>\n' +
                '                                <div class="d-flex '+ align +' my-2">\n' +
                '                                   <a href="/member/page/' + data.sender + '">\n' +
                '                                       <div style="position: relative; width: 3rem; height: 3rem;">\n' +
                '                                           <img ' + imgSrc +
                '                                               class="shadow-sm rounded-circle text-center"\n' +
                '                                               style="position: absolute; top: 0; left: 0; transform: translate(50,50); width: 100%; height: 100%; object-fit: cover; margin: auto">\n' +
                '                                       </div>\n' +
                '                                   </a>\n' +
                                                        msgStr +
                '                                   <div class="flex-fill">\n' +
                '                                    </div>\n' +
                '                                </div>\n' +
                '                            </div>';
            msgArea.appendChild(newMsg);

            setTimeout(scrollEnd, 100);
        }


        //메세지 보내기 버튼 눌렀을 떄..
        function sendMsg(btn) {

            const csrfToken = document.querySelector('input[name="_csrf"]').value;

            var content = document.querySelector('.content');
            var talkMsg = {
                "type": "TALK",
                "roomId": roomId,
                "sender": username,
                "msg": content.value,
                "dataType":1,
            };

            fetch('/direct/message/create',
                {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': csrfToken
                    },
                    body: JSON.stringify(talkMsg)
                })


            socket.send(JSON.stringify(talkMsg));

            
            content.value = '';
            btn.disabled = true;
        }

        function quit() {
            sendDisconnectState(socket);

            const csrfToken = document.querySelector('input[name="_csrf"]').value;


            var quitMsg = {
                "type": "QUIT",
                "roomId": roomId,
                "sender": username
            };

            fetch('/direct/quit',
                {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': csrfToken
                    },
                    body: JSON.stringify(quitMsg)
                })

            socket.send(JSON.stringify(quitMsg));
            socket.close();
        }

        function sendDisconnectState(socket) {
            var enterMsg =
                {
                    "type": "DISCONNECT",
                    "roomId": roomId,
                    "sender": username,
                };

            socket.send(JSON.stringify(enterMsg));
        }

        window.addEventListener('beforeunload', function (e) {
            quit();
        });

        function clickFile()
        {
            var input = document.getElementById('file-sender');

            input.click();
        }

        function directFile(input) {
            if (input.files && input.files[0]) {
                sendImage(input);
            }
        }

        function sendImage(input)
        {
            
            const csrfToken = document.querySelector('input[name="_csrf"]').value;

            const formData = new FormData();
            for (const file of input.files) {
                formData.append('file-sender', file);
            }

            var talkMsg = {
                "type": "TALK",
                "roomId": roomId,
                "sender": username
            };

            formData.append('talkMsg', JSON.stringify(talkMsg));

            fetch('/direct/file/upload',
                {
                    method: 'POST',
                    headers: {
                        'X-CSRF-TOKEN': csrfToken
                    },
                    body: formData
                })
                .then(response => response.json())
                .then(data => {

                    data.msg.forEach( msg =>
                        {
                            var imgMsg = {
                                "type": "TALK",
                                "roomId": data.roomId,
                                "sender": data.sender,
                                "dataType": msg.type,
                                "msg": msg.name,
                                "id" : msg.id
                            };

                            socket.send(JSON.stringify(imgMsg));
                        }
                    )
                })
                .catch(error => {
                    // 에러 처리
                    console.error('Error:', error);
                });
        }

        function deleteMsg(id)
        {

        }
    </script>
</div>
</html>