<html layout:decorate="~{Layout/layout_main}" xmlns:th="http://www.thymeleaf.org">
<head>
    <link rel="stylesheet" type="text/css" th:href="@{/dm/css/DirectInbox.css}">
    <link rel="stylesheet" type="text/css" th:href="@{/dm/css/DirectRoom.css}">
    <link rel="stylesheet" type="text/css" th:href="@{/dm/css/emojibuttonlistjs.min.css}">
    <title>User Page</title>
</head>
<div layout:fragment="content">
    <div class="d-flex">
        <div class="main-content d-flex" style="margin-left: 4.5rem;">
            <div class="border-end" style="min-width: 398px; overflow-y: scroll">
                <ul style=" list-style:none; padding-left:0;">
                    <li class="room-list" th:each="dto:${roomList}" style="padding: 8px 24px">
                        <a th:href="@{|/direct/t/${dto.room.id}|}">
                            <div class="d-flex align-items-center">
                                <div th:each="member : ${dto.members}">
                                    <div th:if="${member.getKey() != loginMember.username}"
                                         style="position: relative; width: 55px; height: 55px; margin-right: 12px">
                                        <img th:if="${member.getValue().getMember().image == null}"
                                             src="/files/designImg/noneuser.png"
                                             class="shadow-sm rounded-circle text-center"
                                             style="position: absolute; top: 0; left: 0; transform: translate(50,50); width: 100%; height: 100%; object-fit: cover; margin: auto">
                                        <img th:unless="${member.getValue().getMember().image == null}"
                                             th:src="@{|/resources/${member.getValue().getMember().image.name}|}"
                                             class="shadow-sm rounded-circle text-center"
                                             style="position: absolute; top: 0; left: 0; transform: translate(50,50); width: 100%; height: 100%; object-fit: cover; margin: auto">
                                    </div>
                                </div>
                                <div>
                                    <div th:text="${dto.name}"></div>
                                    <div>

                                    </div>
                                </div>
                            </div>
                        </a>
                    </li>
                </ul>
            </div>

            <div class="flex-fill border-end">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <input type="hidden" id="group-status" name="group-status" th:value="${nowRoomDTO.group}"/>
                <div>
                    <div>
                        <div class="d-flex justify-content-between border-bottom"
                             style="height: 75px; min-height: 75px; padding: 9px 16px">
                            <div class="d-flex align-items-center">
                                <div th:each="member : ${nowRoomDTO.members}">
                                    <a th:href="@{|/member/page/${member.getValue().getMember().username}|}">
                                        <div th:if="${member.getKey() != loginMember.username}"
                                             style="position: relative; width: 44px; height: 44px; margin: 6px">
                                            <img th:if="${member.getValue().getMember().image == null}"
                                                 src="/files/designImg/noneuser.png"
                                                 class="shadow-sm rounded-circle text-center"
                                                 style="position: absolute; top: 0; left: 0; transform: translate(50,50); width: 100%; height: 100%; object-fit: cover; margin: auto">
                                            <img th:unless="${member.getValue().getMember().image == null}"
                                                 th:src="@{|/resources/${member.getValue().getMember().image.name}|}"
                                                 class="shadow-sm rounded-circle text-center"
                                                 style="position: absolute; top: 0; left: 0; transform: translate(50,50); width: 100%; height: 100%; object-fit: cover; margin: auto">
                                        </div>
                                    </a>
                                </div>
                                <span style="padding: 6px; font-size: 16px;" class="fw-bold"
                                      th:text="${nowRoomDTO.name}"></span>

                            </div>
                            <div class="d-flex align-items-center">
                                <div onclick="clickRoomInfoBtn()"
                                     style="height: 40px" class="d-flex align-items-center">
                                    <svg id="dm-info-open-btn"
                                         aria-label="대화 정보" fill="currentColor"
                                         height="24" role="img" viewBox="0 0 24 24" width="24"><title>대화 정보</title>
                                        <circle cx="12.001" cy="12.005" fill="none" r="10.5" stroke="currentColor"
                                                stroke-linecap="round" stroke-linejoin="round"
                                                stroke-width="2"></circle>
                                        <circle cx="11.819" cy="7.709" r="1.25"></circle>
                                        <line fill="none" stroke="currentColor" stroke-linecap="round"
                                              stroke-linejoin="round" stroke-width="2" x1="10.569" x2="13.432"
                                              y1="16.777"
                                              y2="16.777"></line>
                                        <polyline fill="none" points="10.569 11.05 12 11.05 12 16.777"
                                                  stroke="currentColor"
                                                  stroke-linecap="round" stroke-linejoin="round"
                                                  stroke-width="2"></polyline>
                                    </svg>

                                    <svg id="dm-info-close-btn" class="hidden"
                                         aria-label="대화 정보" fill="currentColor"
                                         height="24" role="img" viewBox="0 0 24 24" width="24"><title>대화 정보</title>
                                        <path d="M12.001.504a11.5 11.5 0 1 0 11.5 11.5 11.513 11.513 0 0 0-11.5-11.5Zm-.182 5.955a1.25 1.25 0 1 1-1.25 1.25 1.25 1.25 0 0 1 1.25-1.25Zm1.614 11.318h-2.865a1 1 0 0 1 0-2H11V12.05h-.432a1 1 0 0 1 0-2H12a1 1 0 0 1 1 1v4.727h.433a1 1 0 1 1 0 2Z"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" id="room-id" th:value="${nowRoomDTO.room.id}">
                    <input type="hidden" id="loginUser-username" th:value="${loginMember.username}">
                </div>
                <div id="msg-area-container" class="d-flex justify-content-center align-items-center"
                     th:style="${!nowRoomDTO.group && nowRoomDTO.block}?'height: calc(100vh - 75px - 129px);':'height: calc(100vh - 75px - 78px);'">
                    <div class="w-100 h-100 d-flex align-items-center justify-content-center" id="spin-container">
                        <span class="spinner-border">

                        </span>
                    </div>
                    <div id="msg-container" class="w-100 h-100" style="overflow-y: scroll; display: none;">
                        <div class="msgArea position-relative">
                            <div style="height: 16px">

                            </div>
                            <div th:each="msg, iterStat : ${messageList}" class="dm-area">
                                <div th:id="'msg'+${msg.id}" th:if="${msg.member.username == loginMember.username}"
                                     style="margin-top: 7px;">
                                    <div class="d-flex justify-content-end">
                                        <div>
                                            <div th:id="'comment-area-num'+${msg.id}"
                                                 th:if="${msg.dataType == 1 && msg.commented}"
                                                 style="margin-right: 6px; margin-bottom: 6px;">
                                                <div th:if="${msg.comment.messageMap.member.username == loginMember.username}">
                                                    <div class="text-end mb-2"
                                                         style="font-size: 12px; color: #797979; padding: 10px 8px 0 0">
                                                        회원님이 자신에게 보낸 답장
                                                    </div>
                                                </div>
                                                <div th:unless="${msg.comment.messageMap.member.username == loginMember.username}">
                                                    <div class="text-end mb-2"
                                                         style="font-size: 12px; color: #797979; padding: 10px 8px 0 0"
                                                         th:text="@{|회원님이 ${msg.comment.messageMap.member.nickname == ''?msg.comment.messageMap.member.username:msg.comment.messageMap.member.nickname}님에게 보낸 답장|}">
                                                    </div>
                                                </div>
                                                <div>
                                                    <div class="d-flex justify-content-end">
                                                        <div th:if="${msg.comment.messageMap.dataType == 1}"
                                                             style="background:#efefef; border-radius: 18px; font-size: 14px; padding: 8px 12px"
                                                             class="mx-2"
                                                             th:text="${msg.message.content}">
                                                        </div>

                                                        <div th:if="${msg.comment.messageMap.dataType == 2}"
                                                             onclick="clickShowImage(this)"
                                                             th:data-id="${msg.image.name}"
                                                             class="mx-2" type="button"
                                                             data-bs-toggle="modal" data-bs-target="#showDataModal">
                                                            <img th:src="@{|/resources/${msg.image.name}|}"
                                                                 style="width: 10rem; height: auto; border-radius: 18px">
                                                        </div>

                                                        <div th:if="${msg.comment.messageMap.dataType == 3}"
                                                             th:data-id="${msg.video.name}"
                                                             onclick="clickShowVideo(this)"
                                                             type="button"
                                                             data-bs-toggle="modal" data-bs-target="#showDataModal"
                                                             class="mx-2 d-flex justify-content-end position-relative">
                                                            <span style="position: absolute;">
                                                                <img height="45" width="45" alt=""
                                                                     src="/files/designImg/playButton.png">
                                                            </span>
                                                            <video style="width: 10rem; height: auto; border-radius: 18px"
                                                                   th:src="@{|/resources/${msg.video.name}|}">
                                                            </video>
                                                        </div>

                                                        <div style="background:#efefef; width: 4px; min-height: 34px">
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="d-flex align-items-center justify-content-end">
                                                <div class="d-flex align-items-center dm-supply-menu"
                                                     style="margin-right: 5px">
                                                    <div style="margin-right: 8px;">
                                                        <a th:id="${msg.id}"
                                                           data-user="true" class="border-0 popover-btn px-1"
                                                           tabindex="0" data-bs-trigger="focus"
                                                           style="background: none; color: #9f9f9f"
                                                           data-bs-container="body" data-bs-toggle="popover"
                                                           data-bs-placement="top" data-bs-target="popover"
                                                           data-bs-html="true">
                                                            <svg aria-label="더 보기" fill="currentColor" height="16"
                                                                 role="img" viewBox="0 0 24 24" width="16"><title>더
                                                                보기</title>
                                                                <circle cx="12" cy="12" r="1.5"></circle>
                                                                <circle cx="6" cy="12" r="1.5"></circle>
                                                                <circle cx="18" cy="12" r="1.5"></circle>
                                                            </svg>
                                                        </a>
                                                    </div>

                                                    <div style="margin-right: 8px; color: #9f9f9f">
                                                        <button th:id="${msg.id}" data-user="true"
                                                                th:data-user-name="${msg.member.username}"
                                                                th:data-msg-content="${msg.dataType == 1 && msg.commented}?${msg.comment.message.content}:(${msg.dataType == 1 && !msg.commented}? ${msg.message.content} : '')"
                                                                th:data-type="${msg.dataType}"
                                                                class="border-0 px-1" onclick="clickComment(this)"
                                                                style="background: none; color: #9f9f9f"
                                                                data-bs-container="body">
                                                            <svg aria-label="답장" fill="currentColor" height="16"
                                                                 role="img" viewBox="0 0 24 24" width="16"><title>
                                                                답장</title>
                                                                <path d="M14 8.999H4.413l5.294-5.292a1 1 0 1 0-1.414-1.414l-7 6.998c-.014.014-.019.033-.032.048A.933.933 0 0 0 1 9.998V10c0 .027.013.05.015.076a.907.907 0 0 0 .282.634l6.996 6.998a1 1 0 0 0 1.414-1.414L4.415 11H14a7.008 7.008 0 0 1 7 7v3.006a1 1 0 0 0 2 0V18a9.01 9.01 0 0 0-9-9Z"></path>
                                                            </svg>
                                                        </button>
                                                    </div>
                                                    <div style="margin-right: 8px; color: #9f9f9f">
                                                        <button th:data-id="${msg.id}" class="emoji-btn border-0 px-1" onclick="clickEmojiMenu(event, this)"
                                                                style="background: none; color: #9f9f9f">
                                                            <svg aria-label="공감" fill="currentColor" height="16"
                                                                 role="img"
                                                                 viewBox="0 0 24 24" width="16"><title>공감</title>
                                                                <path d="M15.83 10.997a1.167 1.167 0 1 0 1.167 1.167 1.167 1.167 0 0 0-1.167-1.167Zm-6.5 1.167a1.167 1.167 0 1 0-1.166 1.167 1.167 1.167 0 0 0 1.166-1.167Zm5.163 3.24a3.406 3.406 0 0 1-4.982.007 1 1 0 1 0-1.557 1.256 5.397 5.397 0 0 0 8.09 0 1 1 0 0 0-1.55-1.263ZM12 .503a11.5 11.5 0 1 0 11.5 11.5A11.513 11.513 0 0 0 12 .503Zm0 21a9.5 9.5 0 1 1 9.5-9.5 9.51 9.51 0 0 1-9.5 9.5Z"></path>
                                                            </svg>
                                                        </button>
                                                    </div>
                                                </div>
                                                <div th:if="${msg.dataType == 1 && !msg.commented}"
                                                     class="text-light"
                                                     style="border-radius: 18px; padding: 7px 12px; background: #3797F0; font-size: 15px"
                                                     th:text="${msg.message.content}">
                                                </div>
                                                <div th:if="${msg.dataType == 1 && msg.commented}">
                                                    <div class="text-light"
                                                         style="border-radius: 18px;  padding: 7px 12px; background: #3797F0; font-size: 15px"
                                                         th:text="${msg.comment.message.content}">
                                                    </div>
                                                </div>
                                                <div th:if="${msg.dataType == 2}"
                                                     th:data-id="${msg.image.name}"
                                                     onclick="clickShowImage(this)"
                                                     type="button"
                                                     data-bs-toggle="modal" data-bs-target="#showDataModal">
                                                    <img th:src="@{|/resources/${msg.image.name}|}"
                                                         style="width: 15rem; height: auto; border-radius: 18px 4px 18px 18px">
                                                </div>
                                                <div th:if="${msg.dataType == 3}"
                                                     th:data-id="${msg.video.name}"
                                                     onclick="clickShowVideo(this)"
                                                     type="button"
                                                     data-bs-toggle="modal" data-bs-target="#showDataModal"
                                                     class="d-flex justify-content-end position-relative">
                                                    <span style="position: absolute;">
                                                        <img height="45" width="45" alt=""
                                                             src="/files/designImg/playButton.png">
                                                    </span>
                                                    <video style="width: 15rem; height: auto; border-radius: 18px 4px 18px 18px"
                                                           th:src="@{|/resources/${msg.video.name}|}">
                                                    </video>
                                                </div>
                                            </div>
                                            <div class="d-flex justify-content-end">
                                                <div th:classappend="${#lists.isEmpty(msg.emojis)}?'visually-hidden'"
                                                     th:id="'emoji-area'+${msg.id}"
                                                     class="d-flex justify-content-center rounded-5"
                                                     style="background: #efefef; border: white 2px solid; max-height: 24px; padding: 0 6px; transform: translateY(-11px);">
                                                    <div th:each="emoji : ${msg.emojis}"
                                                         style="font-size: 12px"
                                                         th:id="'emoji'+${emoji.id}"
                                                         th:text="${emoji.content}">
                                                    </div>
                                                </div>
                                            </div>
                                            <div th:classappend="${iterStat.last}?'read-check'" class="text-end"
                                                 style="font-size: 12px; color: #737373"
                                                 th:text="${iterStat.last}?${msg.seeMember}:''"></div>
                                        </div>
                                        <div style="width: 16px">

                                        </div>
                                    </div>
                                </div>
                                <div th:unless="${msg.member.username == loginMember.username}"
                                     style="margin-top: 7px;"
                                     th:id="'msg'+${msg.id}">
                                    <div th:id="'message-sender-name'+${msg.id}"
                                         th:classappend="${msg.commented}?'hidden'"
                                         style="margin-left: 44px; margin-top:10px; padding: 0 0 6px 12px; font-size: 12px; color: #737373"
                                         th:text="${msg.member.nickname==''}?${msg.member.username}:${msg.member.nickname}"></div>

                                    <div th:id="'comment-area-num'+${msg.id}"
                                         th:if="${msg.dataType == 1 && msg.commented}"
                                         style="margin-right: 6px; margin-left: 44px; margin-bottom: 6px;">
                                        <div th:if="${msg.comment.messageMap.member.username == msg.member.username}"
                                             style="padding: 10px 0 0 8px;">
                                            <div th:if="${msg.member.nickname == ''}"
                                                 class="mb-2" style="font-size: 12px; color: #797979"
                                                 th:text="@{|${msg.member.username}님이 자신에게 보낸 답장|}">
                                            </div>
                                            <div th:unless="${msg.member.nickname == ''}"
                                                 class="mb-2" style="font-size: 12px; color: #797979"
                                                 th:text="@{|${msg.member.nickname}님이 자신에게 보낸 답장|}">
                                            </div>
                                        </div>
                                        <div th:unless="${msg.comment.messageMap.member.username == msg.member.username}"
                                             style="padding: 10px 0 0 8px;">
                                            <div th:if="${msg.comment.messageMap.member.username == loginMember.username}">
                                                <div class="mb-2" style="font-size: 12px; color: #797979"
                                                     th:text="@{|${msg.member.nickname==''?msg.member.username:msg.member.nickname}님이 회원님에게 보낸 답장|}">
                                                </div>
                                            </div>
                                            <div th:unless="${msg.comment.messageMap.member.username == loginMember.username}">
                                                <div class="mb-2" style="font-size: 12px; color: #797979"
                                                     th:text="@{|${msg.member.nickname==''?msg.member.username:msg.member.nickname}님이
                                                     ${msg.comment.messageMap.member.nickname==''?msg.comment.messageMap.member.username:msg.comment.messageMap.member.nickname}님에게 보낸 답장|}">
                                                </div>
                                            </div>
                                        </div>
                                        <div>
                                            <div class="d-flex">
                                                <div style="background:#efefef; width: 4px; min-height: 34px">
                                                </div>
                                                <div th:if="${msg.comment.messageMap.dataType == 1}"
                                                     style="border-radius: 18px; background:#efefef; font-size: 14px; padding: 8px 12px"
                                                     class="mx-2"
                                                     th:text="${msg.message.content}">
                                                </div>

                                                <div th:if="${msg.comment.messageMap.dataType == 2}"
                                                     onclick="clickShowImage(this)"
                                                     th:data-id="${msg.image.name}"
                                                     class="mx-2" type="button"
                                                     data-bs-toggle="modal" data-bs-target="#showDataModal">
                                                    <img th:src="@{|/resources/${msg.image.name}|}"
                                                         style="width: 10rem; height: auto; border-radius: 18px">
                                                </div>

                                                <div th:if="${msg.comment.messageMap.dataType == 3}"
                                                     th:data-id="${msg.video.name}"
                                                     onclick="clickShowVideo(this)"
                                                     type="button"
                                                     data-bs-toggle="modal" data-bs-target="#showDataModal"
                                                     class="mx-2 d-flex justify-content-end position-relative">
                                                            <span style="position: absolute;">
                                                                <img height="45" width="45" alt=""
                                                                     src="/files/designImg/playButton.png">
                                                            </span>
                                                    <video style="width: 10rem; height: auto; border-radius: 18px"
                                                           th:src="@{|/resources/${msg.video.name}|}">
                                                    </video>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="d-flex" th:classappend="${msg.dataType == 1}?'align-items-center'">
                                        <a th:href="@{|/member/page/${msg.member.username}|}">
                                            <div style="position: relative; width: 28px; height: 28px; margin:0 8px 0 14px">
                                                <img th:if="${msg.member.image == null}"
                                                     src="/files/designImg/noneuser.png"
                                                     class="shadow-sm rounded-circle text-center"
                                                     style="position: absolute; top: 0; left: 0; transform: translate(50,50); width: 100%; height: 100%; object-fit: cover; margin: auto">
                                                <img th:unless="${msg.member.image == null}"
                                                     th:src="@{|/resources/${msg.member.image.name}|}"
                                                     class="shadow-sm rounded-circle text-center"
                                                     style="position: absolute; top: 0; left: 0; transform: translate(50,50); width: 100%; height: 100%; object-fit: cover; margin: auto">
                                            </div>
                                        </a>
                                        <div th:if="${msg.dataType == 1 && !msg.commented}" th:id="@{|text${msg.id}|}"
                                             style="border-radius: 18px; background:#efefef; font-size: 15px; padding: 7px 12px; "
                                             th:text="${msg.message.content}">
                                        </div>
                                        <div th:if="${msg.dataType == 1 && msg.commented}" th:id="@{|text${msg.id}|}"
                                             style="border-radius: 18px; background:#efefef; font-size: 15px; padding: 7px 12px;"
                                             th:text="${msg.comment.message.content}">
                                        </div>
                                        <div th:if="${msg.dataType == 2}"
                                             th:data-id="${msg.image.name}"
                                             onclick="clickShowImage(this)"
                                             type="button"
                                             data-bs-toggle="modal" data-bs-target="#showDataModal">
                                            <img th:src="@{|/resources/${msg.image.name}|}"
                                                 style="width: 15rem; height: auto; border-radius: 4px 18px 18px 18px">
                                        </div>
                                        <div th:if="${msg.dataType == 3}" type="button"
                                             th:data-id="${msg.video.name}"
                                             onclick="clickShowVideo(this)"
                                             data-bs-toggle="modal" data-bs-target="#showDataModal"
                                             class="d-flex justify-content-end position-relative">
                                            <span style="position: absolute;">
                                                <img height="45" width="45" alt=""
                                                     src="/files/designImg/playButton.png">
                                            </span>
                                            <video style="width: 15rem; height: auto; border-radius: 4px 18px 18px 18px"
                                                   th:src="@{|/resources/${msg.video.name}|}">
                                            </video>
                                        </div>
                                        <div class="d-flex align-items-center dm-supply-menu" style="margin-left: 5px">
                                            <div style="margin-right: 8px; color: #9f9f9f">
                                                <button th:data-id="${msg.id}" class="emoji-btn border-0 px-1" onclick="clickEmojiMenu(event, this)"
                                                        style="background: none; color: #9f9f9f">
                                                    <svg aria-label="공감" fill="currentColor" height="16"
                                                         role="img"
                                                         viewBox="0 0 24 24" width="16"><title>공감</title>
                                                        <path d="M15.83 10.997a1.167 1.167 0 1 0 1.167 1.167 1.167 1.167 0 0 0-1.167-1.167Zm-6.5 1.167a1.167 1.167 0 1 0-1.166 1.167 1.167 1.167 0 0 0 1.166-1.167Zm5.163 3.24a3.406 3.406 0 0 1-4.982.007 1 1 0 1 0-1.557 1.256 5.397 5.397 0 0 0 8.09 0 1 1 0 0 0-1.55-1.263ZM12 .503a11.5 11.5 0 1 0 11.5 11.5A11.513 11.513 0 0 0 12 .503Zm0 21a9.5 9.5 0 1 1 9.5-9.5 9.51 9.51 0 0 1-9.5 9.5Z"></path>
                                                    </svg>
                                                </button>
                                            </div>
                                            <div style="margin-right: 8px; color: #9f9f9f">
                                                <button th:id="${msg.id}" data-user="false"
                                                        th:data-user-name="${msg.member.username}"
                                                        th:data-msg-content="${msg.dataType == 1 && msg.commented}?${msg.comment.message.content}:(${msg.dataType == 1 && !msg.commented}? ${msg.message.content} : '')"
                                                        th:data-type="${msg.dataType}"
                                                        onclick="clickComment(this)" class="border-0"
                                                        style="background: none; color: #9f9f9f"
                                                        data-bs-container="body">
                                                    <svg aria-label="답장" fill="currentColor" height="16" role="img"
                                                         viewBox="0 0 24 24" width="16"><title>답장</title>
                                                        <path d="M14 8.999H4.413l5.294-5.292a1 1 0 1 0-1.414-1.414l-7 6.998c-.014.014-.019.033-.032.048A.933.933 0 0 0 1 9.998V10c0 .027.013.05.015.076a.907.907 0 0 0 .282.634l6.996 6.998a1 1 0 0 0 1.414-1.414L4.415 11H14a7.008 7.008 0 0 1 7 7v3.006a1 1 0 0 0 2 0V18a9.01 9.01 0 0 0-9-9Z"></path>
                                                    </svg>
                                                </button>
                                            </div>
                                            <div style="margin-right: 8px">
                                                <a th:id="${msg.id}"
                                                   tabindex="0" data-bs-trigger="focus"
                                                   data-user="false"
                                                   th:data-type="${msg.dataType}" class="border-0 popover-btn"
                                                   style="background: none; color: #9f9f9f"
                                                   data-bs-container="body" data-bs-toggle="popover"
                                                   data-bs-placement="top" data-bs-target="popover"
                                                   data-bs-html="true">
                                                    <svg aria-label="더 보기" fill="currentColor" height="16" role="img"
                                                         viewBox="0 0 24 24" width="16"><title>더 보기</title>
                                                        <circle cx="12" cy="12" r="1.5"></circle>
                                                        <circle cx="6" cy="12" r="1.5"></circle>
                                                        <circle cx="18" cy="12" r="1.5"></circle>
                                                    </svg>
                                                </a>
                                            </div>
                                        </div>

                                        <div class="flex-fill">
                                        </div>
                                    </div>
                                    <div class="d-flex">
                                        <div th:classappend="${#lists.isEmpty(msg.emojis)}?'visually-hidden'"
                                             th:id="'emoji-area'+${msg.id}"
                                             class="d-flex justify-content-center rounded-5"
                                             style=" margin-left: 50px; background: #efefef; border: white 2px solid; min-height: 24px; padding: 0 6px; transform: translateY(-11px);">
                                            <div th:each="emoji : ${msg.emojis}"
                                                 th:id="'emoji'+${emoji.id}"
                                                 style="font-size: 12px"
                                                 th:text="${emoji.content}">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div th:classappend="${nowRoomDTO.group || !nowRoomDTO.block} ? '' : 'visually-hidden'" class="not-block-area">
                    <div id="comment-msg-area" data-id="" class="border-top hidden" style="padding: 10px 15px 3px">
                        <div class="d-flex justify-content-between">
                            <div class="d-flex">
                                <div id="comment-msg-name" class="fw-bold" style="font-size: 14px">

                                </div>
                                <div id="comment-user" style="font-size: 14px">
                                    님에게 답장 보내는 중
                                </div>
                            </div>
                            <div onclick="clickCommentCansel()">
                                <svg aria-label="답장 취소" height="12" role="img" viewBox="0 0 24 24" width="12"><title>답장
                                    취소</title>
                                    <polyline fill="none" points="20.643 3.357 12 12 3.353 20.647" stroke="currentColor"
                                              stroke-linecap="round" stroke-linejoin="round" stroke-width="3"></polyline>
                                    <line fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
                                          stroke-width="3" x1="20.649" x2="3.354" y1="20.649" y2="3.354"></line>
                                </svg>
                            </div>
                        </div>
                        <div id="comment-msg-data" style="color: #7b848a; font-size: 13px">

                        </div>
                    </div>
                    <div class="d-flex align-items-center" style="height: 78px; min-height: 78px">
                        <div class="d-flex w-100 px-4">
                            <div class="me-2 flex-fill">
                                <input id="msg-send-input" name="msg-send-input" type="text"
                                       data-type="msg"
                                       placeholder="보낼 메세지를 입력하세요."
                                       class="content form-control" oninput="inputMessage(this)"
                                       onkeydown="inputEnter(event)">
                            </div>
                            <div class="me-2">
                                <button type="button" value="전송" id="send-btn" disabled
                                        class="sendBtn btn btn-primary" onclick="sendMsg(this)">전송
                                </button>
                            </div>
                            <div>
                                <button type="button" value="파일" id="file-send-btn"
                                        class="quit btn btn-primary" onclick="clickFile()">파일
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div th:classappend="${!nowRoomDTO.group && nowRoomDTO.block} ? '':'visually-hidden'" class="border-top block-area">
                    <div class="text-center" style="padding: 16px">
                        <div style="font-size: 14px">
                            이 계정을 차단했습니다
                        </div>
                        <div th:text="@{|${nowRoomDTO.name}님에게 메시지를 보낼 수 없습니다.|}" style="color: #737373; font-size: 12px">
                        </div>
                    </div>
                    <div style="padding: 16px" class="border-top">
                        <div class="d-flex text-center">
                            <div class="w-50 border-end" onclick="clickBlockCancel()"
                                 style="color: #262626; font-size: 14px; font-weight: bold">
                                차단 해제
                            </div>
                            <div class="w-50" style="color: #ED4956; font-size: 14px; font-weight: bold">
                                삭제
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="emoji-input"
                 class="emoji-drop-down custom-scroll-bars visually-hidden"
                 style="display: block;">
                <div class="emoji" onclick="clickEmoji(this)">😁</div>
                <div class="emoji" onclick="clickEmoji(this)">😃</div>
                <div class="emoji" onclick="clickEmoji(this)">😂</div>
                <div class="emoji" onclick="clickEmoji(this)">😄</div>
                <div class="emoji" onclick="clickEmoji(this)">😅</div>
                <div class="emoji" onclick="clickEmoji(this)">😆</div>
                <div class="emoji" onclick="clickEmoji(this)">😇</div>
                <div class="emoji" onclick="clickEmoji(this)">😈</div>
                <div class="emoji" onclick="clickEmoji(this)">😉</div>
                <div class="emoji" onclick="clickEmoji(this)">😊</div>
                <div class="emoji" onclick="clickEmoji(this)">😋</div>
                <div class="emoji" onclick="clickEmoji(this)">😌</div>
                <div class="emoji" onclick="clickEmoji(this)">😍</div>
                <div class="emoji" onclick="clickEmoji(this)">😎</div>
                <div class="emoji" onclick="clickEmoji(this)">😏</div>
                <div class="emoji" onclick="clickEmoji(this)">😐</div>
                <div class="emoji" onclick="clickEmoji(this)">😑</div>
                <div class="emoji" onclick="clickEmoji(this)">😒</div>
                <div class="emoji" onclick="clickEmoji(this)">😓</div>
                <div class="emoji" onclick="clickEmoji(this)">😔</div>
                <div class="emoji" onclick="clickEmoji(this)">😕</div>
                <div class="emoji" onclick="clickEmoji(this)">😖</div>
                <div class="emoji" onclick="clickEmoji(this)">😗</div>
                <div class="emoji" onclick="clickEmoji(this)">😘</div>
                <div class="emoji" onclick="clickEmoji(this)">😙</div>
                <div class="emoji" onclick="clickEmoji(this)">😚</div>
                <div class="emoji" onclick="clickEmoji(this)">😛</div>
                <div class="emoji" onclick="clickEmoji(this)">😜</div>
                <div class="emoji" onclick="clickEmoji(this)">😝</div>
                <div class="emoji" onclick="clickEmoji(this)">😞</div>
                <div class="emoji" onclick="clickEmoji(this)">😟</div>
                <div class="emoji" onclick="clickEmoji(this)">😠</div>
                <div class="emoji" onclick="clickEmoji(this)">😡</div>
                <div class="emoji" onclick="clickEmoji(this)">😢</div>
                <div class="emoji" onclick="clickEmoji(this)">😣</div>
                <div class="emoji" onclick="clickEmoji(this)">😤</div>
                <div class="emoji" onclick="clickEmoji(this)">😥</div>
                <div class="emoji" onclick="clickEmoji(this)">😦</div>
                <div class="emoji" onclick="clickEmoji(this)">😧</div>
                <div class="emoji" onclick="clickEmoji(this)">😨</div>
                <div class="emoji" onclick="clickEmoji(this)">😩</div>
                <div class="emoji" onclick="clickEmoji(this)">😪</div>
                <div class="emoji" onclick="clickEmoji(this)">😫</div>
                <div class="emoji" onclick="clickEmoji(this)">😬</div>
                <div class="emoji" onclick="clickEmoji(this)">😭</div>
                <div class="emoji" onclick="clickEmoji(this)">😮</div>
                <div class="emoji" onclick="clickEmoji(this)">😯</div>
                <div class="emoji" onclick="clickEmoji(this)">😰</div>
                <div class="emoji" onclick="clickEmoji(this)">😱</div>
                <div class="emoji" onclick="clickEmoji(this)">😲</div>
                <div class="emoji" onclick="clickEmoji(this)">😳</div>
                <div class="emoji" onclick="clickEmoji(this)">😴</div>
                <div class="emoji" onclick="clickEmoji(this)">😵</div>
                <div class="emoji" onclick="clickEmoji(this)">😶</div>
                <div class="emoji" onclick="clickEmoji(this)">😷</div>
                <div class="emoji" onclick="clickEmoji(this)">🙁</div>
                <div class="emoji" onclick="clickEmoji(this)">🙂</div>
                <div class="emoji" onclick="clickEmoji(this)">🙃</div>
                <div class="emoji" onclick="clickEmoji(this)">🙄</div>
            </div>

            <div id="dm-info-area" class="h-100 border-end d-flex flex-column visually-hidden"
                 style="min-width: 380px;">
                <!-- dm info -->
                <div class="border-bottom">
                    <!-- dm info title -->
                    <div class="d-flex align-items-center" style="padding: 0 6px; min-height: 75px;">
                        <div style="padding: 0 8px">
                            <span style="font-size: 20px; font-weight: bold;">
                                상세정보
                            </span>
                        </div>
                    </div>
                    <!-- dm notiry setting -->
                    <div>
                        <!-- group dm room name modify(m by n) -->
                        <div th:if="${nowRoomDTO.group}" class="d-flex" style="padding: 14px 24px">
                            <div class="flex-fill d-flex align-items-center">
                                <div>
                                <span style="font-size: 16px;">
                                    그룹 이름 변경
                                </span>
                                </div>
                            </div>
                            <div>
                                <button class="btn btn-primary" style="margin-left: 12px; padding: 3px 12px">
                                    변경
                                </button>
                            </div>
                        </div>

                        <div class="d-flex" style="padding: 14px 24px">
                            <div class="flex-fill d-flex align-items-center">
                                <div>
                                <span style="font-size: 16px;">
                                    메세지 알림 해제
                                </span>
                                </div>
                            </div>
                            <div>
                                <div class="form-check form-switch" style="margin-left: 12px;">
                                    <label>
                                        <input class="form-check-input" type="checkbox" role="switch" id="dm-notify-btn"
                                               style="width: 40px; height: 24px">
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="py-1">

                        </div>
                    </div>
                </div>
                <!-- dm member info -->
                <div class="flex-fill border-bottom">
                    <!-- dm member info title -->
                    <div class="d-flex justify-content-between" style="padding: 24px 24px 14px">
                        <span style="font-size: 16px; font-weight: bold; height: 13px;">
                            멤버
                        </span>
                        <div th:if="${nowRoomDTO.group}" type="button"
                             style="color: #0095F6; font-size: 14px; font-weight: bold; height: 18px;">
                            사람 추가
                        </div>
                    </div>
                    <!-- dm members List -->
                    <div>
                        <a class="dm-members d-flex align-items-center" style="padding: 8px 24px"
                           th:each="member : ${nowRoomDTO.members}"
                           th:id="${member.getValue().getMember().username}"
                           th:href="@{|/member/page/${member.getValue().getMember().username}|}">
                            <div style="padding: 0 12px 0 0">
                                <div style="position: relative; width: 56px; height: 56px;">
                                    <img th:if="${member.getValue().getMember().image == null}"
                                         th:src="${member.getValue().getMember().image == null}?'/files/designImg/noneuser.png':'/resources/'+${member.getValue().getMember().image.name}"
                                         alt="에러"
                                         class="shadow-sm rounded-circle text-center"
                                         style="position: absolute; top: 0; left: 0; transform: translate(50,50); width: 100%; height: 100%; object-fit: cover; margin: auto">
                                </div>
                            </div>
                            <div class="flex-fill">
                                <div>
                                    <span th:text="${member.getValue().getMember().username}"
                                          style="font-size: 14px; font-weight: bold"></span>
                                </div>
                                <div>
                                    <span th:classappend="${member.getValue().block}?'':'visually-hidden'"
                                          th:id="'block'+${member.getValue().getMember().username}"
                                          style="font-size: 14px; color: #737373">차단됨 ·</span>
                                    <span th:text="${member.getValue().getMember().nickname}"
                                          style="font-size: 14px; color: #737373"></span>
                                </div>
                            </div>
                            <div th:if="${nowRoomDTO.group}">
                                <div style="padding: 0 0 0 12px; color: #737373">
                                    <svg th:aria-label="@{|${member.getValue().getMember().nickname==''?member.getValue().getMember().username:member.getValue().getMember().nickname} 멤버 설정|}"
                                         fill="currentColor"
                                         height="24" role="img" viewBox="0 0 24 24" width="24">
                                        <title th:text="@{|${member.getValue().getMember().nickname==''?member.getValue().getMember().username:member.getValue().getMember().nickname} 멤버 설정|}"></title>
                                        <circle cx="12" cy="12" r="1.5"></circle>
                                        <circle cx="12" cy="6" r="1.5"></circle>
                                        <circle cx="12" cy="18" r="1.5"></circle>
                                    </svg>
                                </div>
                            </div>
                        </a>
                    </div>
                </div>

                <!-- dm operate setting -->
                <div style="padding: 8px 24px">
                    <!-- dm block button(1by1) -->
                    <div th:classappend="${!nowRoomDTO.group && !nowRoomDTO.block} ? '' : 'visually-hidden'"
                         onclick="clickBlock()"
                         class="text-danger not-block-area" style="padding: 16px 0">
                        <span style="font-size: 16px">
                            차단
                        </span>
                    </div>
                    <!-- dm block cancel button(1by1) -->
                    <div th:classappend="${!nowRoomDTO.group && nowRoomDTO.block} ? '' : 'visually-hidden'"
                         onclick="clickBlockCancel()"
                         class="text-danger block-area" style="padding: 16px 0">
                        <span style="font-size: 16px">
                            차단 해제
                        </span>
                    </div>
                    <!-- dm room exit button(m by n) -->
                    <div th:if="${nowRoomDTO.group}" class="text-danger" style="padding: 16px 0">
                        <span style="font-size: 16px">
                            채팅방 나가기
                        </span>
                    </div>
                    <!-- dm message delete button -->
                    <div class="text-danger" style="padding: 16px 0">
                        <span style="font-size: 16px">
                            채팅 삭제
                        </span>
                    </div>
                </div>

            </div>
        </div>

        <div class="modal modal-lg fade" id="showDataModal" tabindex="-1" aria-labelledby="exampleModalLabel"
             aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-body">
                        <video id="modal-video" controls autoplay muted class="w-100 h-auto hidden"></video>
                        <img id="modal-image" alt="에러" class="w-100 h-auto hidden">
                    </div>
                </div>
            </div>
        </div>

        <input type="file" accept="image/jpeg, image/png, video/mp4" class="visually-hidden"
               id="file-sender" multiple
               name="file-sender" onchange="directFile(this);">
    </div>

    <script th:inline="javascript">


        let popoverTriggerList = document.querySelectorAll('[data-bs-toggle="popover"]');
        let popoverList = [...popoverTriggerList].map(popoverTriggerEl => new bootstrap.Popover(popoverTriggerEl));

        var dynamicContent = '';
        for (var z = 0; z < popoverList.length; z++) {
            var popover = popoverTriggerList.item(z);
            if (popover.getAttribute('data-user') === 'true') {
                dynamicContent = '<div><div id="' + popover.id + '" class="delete-msg">전송 취소</div></div>';
            } else {
                if (popover.getAttribute('data-type') === '1') {
                    dynamicContent = '<div class="d-flex">' +
                        '<div id="' + popover.id + '" class="resend-msg me-2">전달</div>' +
                        '<div id="' + popover.id + '" class="copy-msg">복사</div>' +
                        '</div>';
                } else {
                    dynamicContent = '<div class="d-flex"><div id="' + popover.id + '" class="resend-msg">전달</div></div>';
                }
            }
            popover.setAttribute('data-bs-content', dynamicContent);
        }

        var myElements = document.getElementsByClassName("popover-btn");

        function createObserver(element) {
            return new MutationObserver(function (mutations) {
                mutations.forEach(function (mutation) {
                    if (mutation.attributeName === 'aria-describedby') {
                        // aria-describedby가 변경되었을 때 실행할 코드
                        var currentValue = element.getAttribute('aria-describedby');

                        if (currentValue !== null) {
                            element.classList.add('show');
                        } else {
                            element.classList.remove('show');
                        }
                    }
                });
            });
        }

        Array.from(myElements).forEach(function (element) {
            var observer = createObserver(element);

            // 옵저버가 감시할 대상과 옵션을 설정합니다.
            var config = {attributes: true};

            // 옵저버를 요소에 등록합니다.
            observer.observe(element, config);
        });

        deleteMsgTrigger();
        resendMsgTrigger();
        copyMsgTrigger();

        function popoverChange() {


            const a = document.querySelectorAll('[data-bs-toggle="popover"]');
            var d = a.length - 1;
            const newPopoverTriggerList = document.querySelectorAll('[data-bs-toggle="popover"]').item(d);
            const newPopoverList = [newPopoverTriggerList].map(popoverTriggerEl => new bootstrap.Popover(popoverTriggerEl));

            popoverList.push(newPopoverList);

            var dynamicContent = '';
            var popover = newPopoverTriggerList;
            if (popover.getAttribute('data-user') === 'true') {
                dynamicContent = '<div><div id="' + popover.id + '" class="delete-msg">전송 취소</div></div>';
            } else {
                if (popover.getAttribute('data-type') === '1') {
                    dynamicContent = '<div class="d-flex">' +
                        '<div id="' + popover.id + '" class="resend-msg me-2">전달</div>' +
                        '<div id="' + popover.id + '" class="copy-msg">복사</div>' +
                        '</div>';
                } else {
                    dynamicContent = '<div class="d-flex"><div id="' + popover.id + '" class="resend-msg">전달</div></div>';
                }
            }
            popover.setAttribute('data-bs-content', dynamicContent);
        }

        function deleteMsgTrigger() {
            $(document).on('click', '.delete-msg', function () {
                // 삭제 동작 수행
                var popID = $(this).parent().parent().parent().attr('id');
                var msgID = $(this).attr('id');
                // Popover 닫기 (선택 사항)
                deleteMsg(msgID, popID);

                closeCommentArea();
            });
        }

        function closeCommentArea() {
            document.getElementById('msg-send-input').dataset.type = 'msg';
            var area = document.getElementById('comment-msg-area');
            area.dataset.id = '';

            if (!area.classList.contains("hidden")) {
                area.classList.add("hidden");

                var msgArea = document.getElementById('msg-area-container');
                msgArea.style.height = 'calc(100vh - 75px - 78px)';
            }
            document.getElementById('file-send-btn').disabled = false;
        }

        function openCommentArea(id) {
            document.getElementById('msg-send-input').dataset.type = 'comment';
            var area = document.getElementById('comment-msg-area');
            area.dataset.id = id;

            if (area.classList.contains("hidden")) {
                area.classList.remove("hidden");

                var msgArea = document.getElementById('msg-area-container');
                msgArea.style.height = 'calc(100vh - 75px - 135.5px)';
            }

            document.getElementById('file-send-btn').disabled = true;
        }


        function resendMsgTrigger() {
            $(document).on('click', '.resend-msg', function () {
                // 삭제 동작 수행
                var popID = $(this).parent().parent().parent().attr('id');
                var msgID = $(this).attr('id');
                // Popover 닫기 (선택 사항)
                resendMsg(msgID, popID);
            });
        }

        function copyMsgTrigger() {

            $(document).on('click', '.copy-msg', function () {
                // 삭제 동작 수행
                var msgID = $(this).attr('id');
                // Popover 닫기 (선택 사항)
                copyMsg(msgID);
            });
        }

        function clickComment(data) {

            openCommentArea(data.id);

            var name = document.getElementById('comment-msg-name');


            if (data.dataset.user === 'true') {
                name.textContent = '';
                document.getElementById('comment-user').textContent = "나에게 답장 보내는 중";
            } else {
                document.getElementById('comment-user').textContent = "님에게 답장 보내는 중";
                name.textContent = data.dataset.userName;
            }

            var content = document.getElementById('comment-msg-data');


            var dataType = data.dataset.type;
            if (dataType === '1') {
                content.textContent = data.dataset.msgContent;
            } else if (dataType === '2') {
                content.textContent = '이미지';
            } else if (dataType === '3') {
                content.textContent = '동영상';
            }
        }

        function clickCommentCansel() {
            closeCommentArea();
        }

        var sideCheck = document.getElementById('expand-direct-menu');
        sideCheck.checked = true;

        var sidebar = document.getElementById('side_bar');
        sidebar.style.width = '4.5rem';

        var sidemenu = document.getElementById('side_menu');
        sidemenu.style.width = '4.5rem';

        setTimeout(() => {

            document.getElementById('spin-container').remove();
            document.getElementById("msg-container").style.display = 'block';
            scrollEnd();
        }, 1200);

        var roomId = document.getElementById('room-id').value;
        var username = document.getElementById('loginUser-username').value;
        var groupStatus = document.getElementById('group-status').value;
        let msgArea = document.querySelector('.msgArea');
        var connectMember = [];

        function inputMessage(input) {
            var sendBtn = document.getElementById('send-btn');
            sendBtn.disabled = input.value === '';
        }

        function inputEnter(event) {
            var sendBtn = document.getElementById('send-btn');
            if (event.key === 'Enter') {

                if (!sendBtn.disabled) {
                    sendBtn.click();
                }
            }
        }

        function enterRoom(socket) {

            var enterMsg =
                {
                    "type": "ENTER",
                    "roomId": roomId,
                    "sender": username,
                };

            socket.send(JSON.stringify(enterMsg));

            const csrfToken = document.querySelector('input[name="_csrf"]').value;
            fetch('/direct/quit',
                {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': csrfToken
                    },
                    body: JSON.stringify(enterMsg)
                })
        }


        // let socket = new WebSocket("wss://www.igstudy.site/ws/chat");
        let socket = new WebSocket("ws://localhost:8888/ws/chat");


        socket.onopen = function (e) {

            console.log('open server!')
            enterRoom(socket);
        };

        socket.onclose = function (e) {
            console.log('disconnet');
        }

        socket.onerror = function (e) {

            console.log(e);
        }

        //메세지 수신했을 때 이벤트.
        socket.onmessage = function (e) {

            const csrfToken = document.querySelector('input[name="_csrf"]').value;

            console.log(e.data);


            var data = JSON.parse(e.data);
            if (data.type === 'TALK' && data.sender === username) {
                createMineMessage(data);
            } else if (data.type === 'TALK' && data.sender !== username) {
                createMessage(data);

                setTimeout(() => {
                    fetch('/direct/readMessage',
                        {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRF-TOKEN': csrfToken
                            },
                            body: JSON.stringify(data)
                        });
                }, 100);

            } else if (data.type === 'ENTER' && data.sender !== username) {
                sendConnectState(socket);

                if (!connectMember.includes(data.sender)) {
                    connectMember.push(data.sender);
                }

                readMessage(data);
            } else if (data.type === 'CONNECT' && data.sender !== username) {
                if (!connectMember.includes(data.sender)) {
                    connectMember.push(data.sender);
                }
            } else if (data.type === 'DISCONNECT' && data.sender !== username) {
                let index = connectMember.indexOf(data.sender);
                if (index !== -1) {
                    connectMember.splice(index, 1);
                }
            } else if (data.type === 'DELETE' && data.sender !== username) {

                var msgContainer = document.getElementById('msg' + data.id);

                msgContainer.remove();
            } else if (data.type === 'DELETE_COMMENT') {


                var commentArea = document.getElementById('comment-area-num' + data.id);
                var senderNameArea = document.getElementById('message-sender-name' + data.id);

                commentArea.remove();
                senderNameArea.classList.remove('hidden');
            }
            else if(data.type === 'EMOJI')
            {

                var emojiArea = document.getElementById('emoji-area'+data.msgId);

                if(emojiArea.classList.contains('visually-hidden'))
                {
                    emojiArea.classList.remove('visually-hidden');
                }

                debugger;
                var div = '';
                if(data.isNewEmoji)
                {
                    div = document.createElement('div');
                    div.style.fontSize = '12px';
                    div.textContent = data.emoji;
                    div.id = 'emoji'+ data.emojiId;
                }
                else
                {
                    div = document.getElementById('emoji'+ data.emojiId);
                    div.textContent = data.emoji;
                }

                emojiArea.appendChild(div);

                scrollEnd();
            }
        }

        function clickShowImage(div) {
            var image = document.getElementById('modal-image');
            image.setAttribute('src', '/resources/' + div.dataset.id);
            image.classList.remove('hidden');

            var video = document.getElementById('modal-video');
            video.setAttribute('src', '');
            video.classList.add('hidden');
        }

        function clickShowVideo(div) {
            var video = document.getElementById('modal-video');
            video.setAttribute('src', '/resources/' + div.dataset.id);
            video.classList.remove('hidden');

            var image = document.getElementById('modal-image');
            image.setAttribute('src', '');
            image.classList.add('hidden');
        }

        function sendConnectState(socket) {

            var enterMsg =
                {
                    "type": "CONNECT",
                    "roomId": roomId,
                    "sender": username,
                };

            socket.send(JSON.stringify(enterMsg));
        }

        function readMessage(data) {
            var readCheck = document.getElementsByClassName('read-check');

            for (var i = 0; i < readCheck.length; i++) {
                var userNames = '';

                for (var j = 0; j < connectMember.length; j++) {

                    userNames += connectMember[j];
                    if (j !== connectMember.length - 1) {
                        userNames += '님이, ';
                    }
                }

                readCheck.item(i).textContent = userNames + '님이 확인함';
            }
            scrollEnd();
        }

        function createMineMessage(data) {

            var readCheck = document.getElementsByClassName('read-check');

            for (var j = 0; j < readCheck.length; j++) {
                readCheck.item(j).textContent = '';
                readCheck.item(j).classList.remove('read-check');
            }

            var read = '';
            for (var i = 0; i < connectMember.length; i++) {
                read += connectMember[i] + '님';
                if (i !== connectMember.length - 1) {
                    read += ',';
                } else {
                    read += '이 확인함';
                }
            }

            var msgStr = '';
            var modal = '';
            var comment = '';


            if (data.dataType === 1) {
                msgStr =
                    '<div class="text-light" style="border-radius: 18px; padding: 7px 12px; background: #3797F0; font-size: 15px">\n' +
                    data.msg +
                    '</div>\n';

                if (data.commented === 'true') {

                    var userText = '';
                    if (data.commentUsername === username) {
                        userText =
                            '            <div class="text-end mb-2" style="font-size: 12px; color: #797979; padding: 10px 8px 0 0">\n' +
                            '                회원님이 자신에게 보낸 답장\n' +
                            '            </div>\n';
                    } else {
                        userText =
                            '            <div class="text-end mb-2" style="font-size: 12px; color: #797979; padding: 10px 8px 0 0">\n' +
                            '회원님이 ' + data.commentUserText + '님에게 보낸 답장' +
                            '            </div>\n';
                    }

                    var commentContent = '';

                    if (data.commentDataType === 1) {
                        commentContent =
                            '                <div style="border-radius: 18px; background:#efefef; font-size: 14px; padding: 8px 12px"\n' +
                            '                     class="mx-2">\n' +
                            data.commentContent +
                            '                </div>\n';
                    } else if (data.commentDataType === 2) {
                        commentContent =
                            '                <div onclick="clickShowImage(this)"\n' +
                            '                     data-id="' + data.commentContent + '"\n' +
                            '                     class="mx-2" type="button"\n' +
                            '                     data-bs-toggle="modal" data-bs-target="#showDataModal">\n' +
                            '                    <img src="/resources/' + data.commentContent + '"\n' +
                            '                         style="width: 10rem; height: auto; border-radius: 18px">\n' +
                            '                </div>\n';
                    } else if (data.commentDataType === 3) {
                        commentContent =
                            '                <div data-id="' + data.commentContent + '"\n' +
                            '                     onclick="clickShowVideo(this)"\n' +
                            '                     type="button"\n' +
                            '                     data-bs-toggle="modal" data-bs-target="#showDataModal"\n' +
                            '                     class="mx-2 d-flex justify-content-end position-relative">\n' +
                            '                    <span style="position: absolute;">\n' +
                            '                        <img height="45" width="45" alt=""\n' +
                            '                             src="/files/designImg/playButton.png">\n' +
                            '                    </span>\n' +
                            '                    <video style="width: 10rem; height: auto; border-radius: 18px"\n' +
                            '                           src="/resources/' + data.commentContent + '">\n' +
                            '                    </video>\n' +
                            '                </div>\n';
                    }
                    comment =
                        '   <div id="comment-area-num' + data.id + '" style="margin-right: 6px; margin-bottom: 6px;">\n' +
                        userText +
                        '        <div>\n' +
                        '            <div class="d-flex justify-content-end">\n' +
                        commentContent +
                        '                <div style="background:#efefef; width: 4px; min-height: 34px">\n' +
                        '                </div>\n' +
                        '            </div>\n' +
                        '        </div>\n' +
                        '    </div>';
                }
            } else if (data.dataType === 2) {
                modal = ' data-id="' + data.msg + '"\n' +
                    ' onclick="clickShowImage(this)"' +
                    ' type="button" data-bs-toggle="modal" data-bs-target="#showDataModal"';
                msgStr =
                    '<div ' + modal + '>\n' +
                    '    <img src="/resources/' + data.msg + '" style="width: 15rem; height: auto; border-radius: 18px 4px 18px 18px">\n' +
                    '</div>';
            } else if (data.dataType === 3) {
                modal = ' data-id="' + data.msg + '"\n' +
                    ' onclick="clickShowVideo(this)"' +
                    ' type="button" data-bs-toggle="modal" data-bs-target="#showDataModal"';
                msgStr =
                    '<div class="d-flex justify-content-end position-relative" ' + modal + '>\n' +
                    '       <span style="position: absolute;">\n' +
                    '             <img height="45" width="45" alt="" src="/files/designImg/playButton.png">\n' +
                    '       </span>' +
                    '       <video style="width: 15rem; height: auto; border-radius: 18px 4px 18px 18px" src="/resources/' + data.msg + '">\n' +
                    '       </video>' +
                    '</div>';
            }


            let newMsg = document.createElement('div');
            newMsg.innerHTML =
                '                           <div id="msg' + data.id + '" style="margin-top: 7px;" class="dm-area">\n' +
                '                                <div class="d-flex justify-content-end">\n' +
                '                                    <div >\n' +
                comment +
                '                                        <div class="d-flex align-items-center justify-content-end">\n' +
                '                                       <div class="d-flex align-items-center dm-supply-menu" style="margin-right: 5px">\n' +
                '                                            <div style="margin-right:8px;">\n' +
                '                                                <a id="' + data.id + '" tabindex="0" data-bs-trigger="focus" data-user="true" data-type="' + data.dataType + '"  type="button" class="border-0 popover-btn" style="background: none; color: #9f9f9f" data-bs-container="body" data-bs-toggle="popover" data-bs-placement="top" data-bs-target="popover" data-bs-html="true">\n' +
                '                                                    <svg aria-label="더 보기" fill="currentColor" height="16" role="img" viewBox="0 0 24 24" width="16"><title>더 보기</title><circle cx="12" cy="12" r="1.5"></circle><circle cx="6" cy="12" r="1.5"></circle><circle cx="18" cy="12" r="1.5"></circle></svg>\n' +
                '                                                </a>\n' +
                '                                            </div>\n' +
                '                                            <div style="margin-right: 8px; color: #9f9f9f">\n' +
                '                                                <button id="' + data.id + '" data-user="true"\n' +
                '                                                  data-user-name=' + username + '\n' +
                '                                                  data-type="' + data.dataType + '"\n' +
                '                                                  data-msg-content="' + data.msg + '"' +
                '                                                  class="border-0" onclick="clickComment(this)"\n' +
                '                                                  style="background: none; color: #9f9f9f"\n' +
                '                                                  data-bs-container="body">\n' +
                '                                                    <svg aria-label="답장" fill="currentColor" height="16"\n' +
                '                                                       role="img" viewBox="0 0 24 24" width="16"><title>\n' +
                '                                                       답장</title>\n' +
                '                                                       <path d="M14 8.999H4.413l5.294-5.292a1 1 0 1 0-1.414-1.414l-7 6.998c-.014.014-.019.033-.032.048A.933.933 0 0 0 1 9.998V10c0 .027.013.05.015.076a.907.907 0 0 0 .282.634l6.996 6.998a1 1 0 0 0 1.414-1.414L4.415 11H14a7.008 7.008 0 0 1 7 7v3.006a1 1 0 0 0 2 0V18a9.01 9.01 0 0 0-9-9Z"></path>\n' +
                '                                                    </svg>\n' +
                '                                                 </button>\n' +
                '                                            </div>' +
                '                                            <div style="margin-right: 8px; color: #9f9f9f">\n' +
                '                                               <button data-id="'+data.id+'" class="emoji-btn border-0 px-1" onclick="clickEmojiMenu(event,this)"\n' +
                '                                                        style="background: none; color: #9f9f9f">\n' +
                '                                                    <svg aria-label="공감" fill="currentColor" height="16"\n' +
                '                                                         role="img"\n' +
                '                                                         viewBox="0 0 24 24" width="16"><title>공감</title>\n' +
                '                                                        <path d="M15.83 10.997a1.167 1.167 0 1 0 1.167 1.167 1.167 1.167 0 0 0-1.167-1.167Zm-6.5 1.167a1.167 1.167 0 1 0-1.166 1.167 1.167 1.167 0 0 0 1.166-1.167Zm5.163 3.24a3.406 3.406 0 0 1-4.982.007 1 1 0 1 0-1.557 1.256 5.397 5.397 0 0 0 8.09 0 1 1 0 0 0-1.55-1.263ZM12 .503a11.5 11.5 0 1 0 11.5 11.5A11.513 11.513 0 0 0 12 .503Zm0 21a9.5 9.5 0 1 1 9.5-9.5 9.51 9.51 0 0 1-9.5 9.5Z"></path>\n' +
                '                                                    </svg>\n' +
                '                                                </button>'+
                '                                            </div>\n' +
                '                                        </div>' +
                msgStr +
                '                                        </div>\n' +
                '                                        <div class="d-flex justify-content-end">\n' +
                '                                                <div id="emoji-area'+data.id+'"\n' +
                '                                                     class="d-flex justify-content-center rounded-5 visually-hidden" \n' +
                '                                                     style="background: #efefef; border: white 2px solid; max-height: 24px; padding: 0 6px; transform: translateY(-11px);">\n' +
                '                                                </div>\n' +
                '                                        </div>\n' +
                '                                        <div class="read-check text-end" style="font-size: 12px; color: #737373">\n' +
                read +
                '                                        </div>\n' +
                '                                    </div>\n' +
                '                                    <div style="width: 16px">\n' +
                '                                    </div>\n' +
                '                                </div>\n' +
                '                            </div>';

            msgArea.appendChild(newMsg);

            popoverChange();

            setTimeout(scrollEnd, 100);
        }

        function scrollEnd() {

            var objDiv = document.getElementById("msg-container");
            objDiv.scrollTop = objDiv.scrollHeight;
        }


        function createMessage(data) {

            let newMsg = document.createElement('div');

            var members = [[${nowRoomDTO.members}]];
            var imgSrc = '';
            var img = members[data.sender].image;
            debugger;
            if (img) {
                imgSrc = 'src="/resources/' + img.name + '"\n';
            } else {
                imgSrc = 'src="/files/designImg/noneuser.png"\n';
            }


            var userText =
                '                                <div id="message-sender-name' + data.id + '" style="margin-left: 44px; margin-top:10px; padding: 0 0 6px 12px; font-size: 12px; color: #797979">\n' +
                data.userText +
                '                                </div>\n';

            var msgStr = '';
            var align = '';
            var modal = '';
            var comment = '';
            if (data.dataType === 1) {

                msgStr =
                    '<div id="text' + data.id + '" style="border-radius: 18px; background:#efefef; font-size: 15px; padding: 7px 12px;">' +
                    data.msg +
                    '</div>'

                align = 'align-items-center';

                if (data.commented === 'true') {
                    if (data.commentUsername === data.sender) {
                        userText =
                            '            <div class="mb-2" style="font-size: 12px; color: #797979; padding: 10px 0 0 8px">\n' +
                            '                ' + data.commentUserText + '님이 자신에게 보낸 답장\n' +
                            '            </div>\n';
                    } else {
                        var receive = '';
                        if (data.commentUsername === username) {
                            receive = '회원';
                        } else {
                            receive = data.commentUserText;
                        }
                        userText =
                            '            <div class="mb-2" style="font-size: 12px; color: #797979; padding: 10px 0 0 8px">'
                            + data.userText + '님이 ' + receive + '님에게 보낸 답장' +
                            '            </div>\n';
                    }


                    var commentContent = '';

                    if (data.commentDataType === 1) {
                        commentContent =
                            '                <div style="border-radius: 18px; background:#efefef; font-size: 14px; padding: 8px 12px"\n' +
                            '                     class="mx-2">\n' +
                            data.commentContent +
                            '                </div>\n';
                    } else if (data.commentDataType === 2) {
                        commentContent =
                            '                <div onclick="clickShowImage(this)"\n' +
                            '                     data-id="' + data.commentContent + '"\n' +
                            '                     class="mx-2" type="button"\n' +
                            '                     data-bs-toggle="modal" data-bs-target="#showDataModal">\n' +
                            '                    <img src="/resources/' + data.commentContent + '"\n' +
                            '                         style="width: 10rem; height: auto; border-radius: 18px">\n' +
                            '                </div>\n';
                    } else if (data.commentDataType === 3) {
                        commentContent =
                            '                <div data-id="' + data.commentContent + '"\n' +
                            '                     onclick="clickShowVideo(this)"\n' +
                            '                     type="button"\n' +
                            '                     data-bs-toggle="modal" data-bs-target="#showDataModal"\n' +
                            '                     class="mx-2 d-flex justify-content-end position-relative">\n' +
                            '                    <span style="position: absolute;">\n' +
                            '                        <img height="45" width="45" alt=""\n' +
                            '                             src="/files/designImg/playButton.png">\n' +
                            '                    </span>\n' +
                            '                    <video style="width: 10rem; height: auto; border-radius: 18px"\n' +
                            '                           src="/resources/' + data.commentContent + '">\n' +
                            '                    </video>\n' +
                            '                </div>\n';
                    }
                    comment =
                        '   <div id="comment-area-num' + data.id + '" style="margin-right: 6px; margin-left: 44px; margin-bottom: 6px;">\n' +
                        userText +
                        '        <div>\n' +
                        '            <div class="d-flex">\n' +
                        '                <div style="background:#efefef; width: 4px; min-height: 34px">\n' +
                        '                </div>\n' +
                        commentContent +
                        '            </div>\n' +
                        '        </div>\n' +
                        '    </div>';
                    userText =
                        '                                <div id="message-sender-name' + data.id + '" class="hidden" style="margin-left: 44px; margin-top:10px; padding: 0 0 6px 12px; font-size: 12px; color: #797979">\n' +
                        data.userText +
                        '                                </div>\n';
                }
            } else if (data.dataType === 2) {
                modal = ' data-id="' + data.msg + '"\n' +
                    ' onclick="clickShowImage(this)"' +
                    ' type="button" data-bs-toggle="modal" data-bs-target="#showDataModal"';
                msgStr =
                    '<div ' + modal + '>\n' +
                    '    <img src="/resources/' + data.msg + '" style="width: 15rem; height: auto; border-radius: 4px 18px 18px 18px">\n' +
                    '</div>';
            } else if (data.dataType === 3) {

                modal = ' data-id="' + data.msg + '"\n' +
                    ' onclick="clickShowVideo(this)"' +
                    ' type="button" data-bs-toggle="modal" data-bs-target="#showDataModal"';
                msgStr =
                    '<div class="d-flex justify-content-end position-relative" ' + modal + '>' +
                    '       <span style="position: absolute;">\n' +
                    '             <img height="45" width="45" alt="" src="/files/designImg/playButton.png">\n' +
                    '       </span>' +
                    '       <video style="width: 15rem; height: auto; border-radius: 4px 18px 18px 18px" src="/resources/' + data.msg + '">\n' +
                    '       </video>' +
                    '</div>';
            }

            newMsg.innerHTML =
                '                            <div id="msg' + data.id + '" style="margin-top: 7px;" class="dm-area">\n' +
                userText +
                comment +
                '                                <div class="d-flex ' + align + '">\n' +
                '                                   <a href="/member/page/' + data.sender + '">\n' +
                '                                       <div style="position: relative; width: 28px; height: 28px; margin:0 8px 0 14px">\n' +
                '                                           <img ' + imgSrc +
                '                                               class="shadow-sm rounded-circle text-center"\n' +
                '                                               style="position: absolute; top: 0; left: 0; transform: translate(50,50); width: 100%; height: 100%; object-fit: cover; margin: auto">\n' +
                '                                       </div>\n' +
                '                                   </a>\n' +
                msgStr +
                '                                   <div class="d-flex align-items-center dm-supply-menu" style="margin-left: 5px">\n' +
                '                                            <div style="margin-right: 8px; color: #9f9f9f">\n' +
                '                                            <button data-id="'+data.id+'" class="emoji-btn border-0 px-1" onclick="clickEmojiMenu(event,this)"\n' +
                '                                                        style="background: none; color: #9f9f9f">\n' +
                '                                                    <svg aria-label="공감" fill="currentColor" height="16"\n' +
                '                                                         role="img"\n' +
                '                                                         viewBox="0 0 24 24" width="16"><title>공감</title>\n' +
                '                                                        <path d="M15.83 10.997a1.167 1.167 0 1 0 1.167 1.167 1.167 1.167 0 0 0-1.167-1.167Zm-6.5 1.167a1.167 1.167 0 1 0-1.166 1.167 1.167 1.167 0 0 0 1.166-1.167Zm5.163 3.24a3.406 3.406 0 0 1-4.982.007 1 1 0 1 0-1.557 1.256 5.397 5.397 0 0 0 8.09 0 1 1 0 0 0-1.55-1.263ZM12 .503a11.5 11.5 0 1 0 11.5 11.5A11.513 11.513 0 0 0 12 .503Zm0 21a9.5 9.5 0 1 1 9.5-9.5 9.51 9.51 0 0 1-9.5 9.5Z"></path>\n' +
                '                                                    </svg>\n' +
                '                                                </button>'+
                '                                            </div>\n' +
                '                                            <div style="margin-right: 8px; color: #9f9f9f">\n' +
                '                                                <button id="' + data.id + '" data-user="false" data-user-name="' + data.sender + '" data-msg-content="' + data.msg + '" data-type="' + data.dataType + '" onclick="clickComment(this)" class="border-0" style="background: none; color: #9f9f9f" data-bs-container="body">\n' +
                '                                                    <svg aria-label="답장" fill="currentColor" height="16" role="img" viewBox="0 0 24 24" width="16"><title>답장</title>\n' +
                '                                                        <path d="M14 8.999H4.413l5.294-5.292a1 1 0 1 0-1.414-1.414l-7 6.998c-.014.014-.019.033-.032.048A.933.933 0 0 0 1 9.998V10c0 .027.013.05.015.076a.907.907 0 0 0 .282.634l6.996 6.998a1 1 0 0 0 1.414-1.414L4.415 11H14a7.008 7.008 0 0 1 7 7v3.006a1 1 0 0 0 2 0V18a9.01 9.01 0 0 0-9-9Z"></path>\n' +
                '                                                    </svg>\n' +
                '                                                </button>\n' +
                '                                            </div>\n' +
                '                                            <div style="margin-right:8px;">\n' +
                '                                                <a id="' + data.id + '" tabindex="0" data-bs-trigger="focus" data-user="false" data-type="' + data.dataType + '" class="border-0 popover-btn" style="background: none; color: #9f9f9f" data-bs-container="body" data-bs-toggle="popover" data-bs-placement="top" data-bs-target="popover" data-bs-html="true" data-bs-original-title="" title="">\n' +
                '                                                    <svg aria-label="더 보기" fill="currentColor" height="16" role="img" viewBox="0 0 24 24" width="16"><title>더 보기</title>\n' +
                '                                                        <circle cx="12" cy="12" r="1.5"></circle>\n' +
                '                                                        <circle cx="6" cy="12" r="1.5"></circle>\n' +
                '                                                        <circle cx="18" cy="12" r="1.5"></circle>\n' +
                '                                                    </svg>\n' +
                '                                                </a>\n' +
                '                                            </div>\n' +
                '                                        </div>' +
                '                                   <div class="flex-fill">\n' +
                '                                    </div>\n' +
                '                                </div>\n' +
                '                                <div class="d-flex">\n' +
                '                                        <div id="emoji-area'+data.id+'"\n' +
                '                                             class="d-flex justify-content-center rounded-5 visually-hidden"\n' +
                '                                             style=" margin-left: 50px; background: #efefef; border: white 2px solid; min-height: 24px; padding: 0 6px; transform: translateY(-11px);">\n' +
                '                                        </div>\n' +
                '                                    </div>'+
                '                            </div>';
            msgArea.appendChild(newMsg);

            popoverChange();
            setTimeout(scrollEnd, 100);
        }


        //메세지 보내기 버튼 눌렀을 떄..
        function sendMsg(btn) {

            var input = document.getElementById('msg-send-input');
            const csrfToken = document.querySelector('input[name="_csrf"]').value;
            var content = document.querySelector('.content');

            var area = document.getElementById('comment-msg-area');


            var talkMsg = {
                "type": "TALK",
                "roomId": roomId,
                "sender": username,
                "msg": content.value,
                "dataType": 1
            };

            if (input.dataset.type === 'msg') {

                fetch('/direct/message/create',
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRF-TOKEN': csrfToken
                        },
                        body: JSON.stringify(talkMsg)
                    })
                    .then(response => response.json())
                    .then(data => {
                        talkMsg.id = data.id;
                        talkMsg.userText = data.userText;

                        socket.send(JSON.stringify(talkMsg));
                    })
                    .catch(error => {
                        // 에러 처리
                        console.error('Error:', error);
                    });
            } else if (input.dataset.type === 'comment') {


                talkMsg.mapId = area.dataset.id;
                fetch('/direct/comment/create',
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRF-TOKEN': csrfToken
                        },
                        body: JSON.stringify(talkMsg)
                    })
                    .then(response => response.json())
                    .then(data => {
                        talkMsg.id = data.id;
                        talkMsg.commentContent = data.commentContent;
                        talkMsg.commentDataType = data.commentDataType;
                        talkMsg.commentUsername = data.commentUsername;
                        talkMsg.commentUserText = data.commentUserText;
                        talkMsg.commented = data.commented;
                        talkMsg.userText = data.userText;

                        socket.send(JSON.stringify(talkMsg));
                    })
                    .catch(error => {
                        // 에러 처리
                        console.error('Error:', error);
                    });
            }

            content.value = '';
            btn.disabled = true;
            closeCommentArea();
        }

        function quit() {
            sendDisconnectState(socket);

            const csrfToken = document.querySelector('input[name="_csrf"]').value;


            var quitMsg = {
                "type": "QUIT",
                "roomId": roomId,
                "sender": username
            };

            fetch('/direct/quit',
                {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': csrfToken
                    },
                    body: JSON.stringify(quitMsg)
                })

            socket.send(JSON.stringify(quitMsg));
            socket.close();
        }

        function sendDisconnectState(socket) {
            var enterMsg =
                {
                    "type": "DISCONNECT",
                    "roomId": roomId,
                    "sender": username,
                };

            socket.send(JSON.stringify(enterMsg));
        }

        window.addEventListener('beforeunload', function (e) {
            quit();
        });

        function clickFile() {
            var input = document.getElementById('file-sender');

            input.click();
        }

        function directFile(input) {
            if (input.files && input.files[0]) {
                sendImage(input);
            }
        }

        function sendImage(input) {

            const csrfToken = document.querySelector('input[name="_csrf"]').value;

            const formData = new FormData();
            for (const file of input.files) {
                formData.append('file-sender', file);
            }

            var talkMsg = {
                "type": "TALK",
                "roomId": roomId,
                "sender": username
            };

            formData.append('talkMsg', JSON.stringify(talkMsg));

            fetch('/direct/file/upload',
                {
                    method: 'POST',
                    headers: {
                        'X-CSRF-TOKEN': csrfToken
                    },
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    data.msg.forEach(msg => {
                            var imgMsg = {
                                "type": "TALK",
                                "roomId": data.roomId,
                                "sender": data.sender,
                                "dataType": msg.type,
                                "msg": msg.name,
                                "id": msg.id,
                                "userText": data.userText,
                            };

                            socket.send(JSON.stringify(imgMsg));
                        }
                    )
                })
                .catch(error => {
                    // 에러 처리
                    console.error('Error:', error);
                });
        }

        function deleteMsg(id, popID) {
            var res = confirm("전송을 취소하시겠습니까?");
            if (res) {
                fetch("/direct/delete/" + id)
                    .then(response => response.json())
                    .then(data => {

                        var msgContainer = document.getElementById('msg' + id);
                        msgContainer.remove();
                        var msg = {
                            "type": "DELETE",
                            "roomId": roomId,
                            "sender": username,
                            "id": id
                        };
                        socket.send(JSON.stringify(msg));

                        data.commentIds.forEach(commentID => {
                            var msg = {
                                "type": "DELETE_COMMENT",
                                "roomId": roomId,
                                "sender": username,
                                "id": commentID
                            };
                            socket.send(JSON.stringify(msg));
                        })
                    })
                    .catch(error => {
                        // 에러 처리
                        console.error('Error:', error);
                    });
            }
        }

        function resendMsg(id, popID) {

        }

        function copyMsg(id) {

            var divElement = document.getElementById('text' + id);

            var range = document.createRange();
            range.selectNode(divElement);

            var selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);

            document.execCommand('copy');
        }

        function clickRoomInfoBtn() {

            var infoArea = document.getElementById('dm-info-area');
            var closeBtn = document.getElementById('dm-info-close-btn');
            var openBtn = document.getElementById('dm-info-open-btn');

            if (infoArea.classList.contains('visually-hidden')) {
                infoArea.classList.remove('visually-hidden');
                openBtn.classList.add('hidden');
                closeBtn.classList.remove('hidden');
            } else {
                infoArea.classList.add('visually-hidden');
                openBtn.classList.remove('hidden');
                closeBtn.classList.add('hidden');
            }
        }

        var emojiButton = '';

        function clickEmojiMenu(event, button)
        {
            debugger;
            emojiStateChange(button);
            resizeEmoji(emojiButton, event);
        }

        function emojiStateChange(button)
        {
            var emoji = document.getElementById('emoji-input');
            var buttonIsShow = button.classList.toggle('show');

            if(emojiButton === '' || button === emojiButton)
            {
                emoji.classList.toggle('visually-hidden');
            }
            else if(button !== emojiButton)
            {
                if(emoji.classList.contains('visually-hidden'))
                {
                    emoji.classList.remove('visually-hidden');
                }
                emojiButton.classList.toggle('show');
            }

            if(buttonIsShow)
            {
                emojiButton = button;
            }
            else
            {
                emojiButton = '';
            }
        }

        function resizeEmoji(button, event)
        {
            var emoji = document.getElementById('emoji-input');

            emoji.style.top = event.clientY + button.offsetHeight + 'px';
            emoji.style.left = event.clientX - 212 + 'px';
        }


        window.addEventListener('resize', function() {
            resizeEmoji(emojiButton);
        });

        function clickEmoji(div)
        {

            if(emojiButton !== '')
            {
                const csrfToken = document.querySelector('input[name="_csrf"]').value;

                var directMsg = {
                    "type": 'EMOJI',
                    "roomId": roomId,
                    "sender": username,
                    "msgId" : emojiButton.dataset.id,
                    "emoji" : div.textContent,
                };

                fetch('/direct/emoji/create',
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRF-TOKEN': csrfToken
                        },
                        body: JSON.stringify(directMsg)
                    })
                    .then(response => response.json())
                    .then(data => {

                        socket.send(JSON.stringify(data));

                        emojiStateChange(emojiButton);
                    })
                    .catch(error => {
                        // 에러 처리
                        console.error('Error:', error);
                    });
            }
        }

        function clickBlock()
        {
            var targetMembers = document.getElementsByClassName('dm-members');
            var targetMember = '';

            for(var i = 0; i < targetMembers.length; i++)
            {
                if(targetMembers[i].id !== username)
                {
                    targetMember = targetMembers[i].id;
                    break;
                }
            }

            fetch('/member/block/' + targetMember)
                .then(response => response.json())
                .then(data => {
                    debugger;
                    if(groupStatus === 'false')
                    {
                        var msgArea = document.getElementById('msg-area-container');
                        msgArea.style.height = 'calc(100vh - 75px - 129px)';

                        document.querySelectorAll('.not-block-area').forEach(el => el.classList.add('visually-hidden'));
                        document.querySelectorAll('.block-area').forEach(el => el.classList.remove('visually-hidden'));
                        document.getElementById('block'+targetMember).classList.remove('visually-hidden');
                    }
                })
                .catch(error => {
                    // 에러 처리
                    console.error('Error:', error);
                });
        }

        function clickBlockCancel()
        {
            var targetMembers = document.getElementsByClassName('dm-members');
            var targetMember = '';

            debugger;
            for(var i = 0; i < targetMembers.length; i++)
            {
                if(targetMembers[i].id !== username)
                {
                    targetMember = targetMembers[i].id;
                    break;
                }
            }

            debugger;
            fetch('/member/block/cancel/' + targetMember)
                .then(response => response.json())
                .then(data => {
                    if(groupStatus === 'false')
                    {
                        var msgArea = document.getElementById('msg-area-container');
                        msgArea.style.height = 'calc(100vh - 75px - 78px)';

                        document.querySelectorAll('.not-block-area').forEach(el => el.classList.remove('visually-hidden'));
                        document.querySelectorAll('.block-area').forEach(el => el.classList.add('visually-hidden'));
                        document.getElementById('block'+targetMember).classList.add('visually-hidden');
                    }
                })
                .catch(error => {
                    // 에러 처리
                    console.error('Error:', error);
                });
        }
    </script>
</div>
</html>
