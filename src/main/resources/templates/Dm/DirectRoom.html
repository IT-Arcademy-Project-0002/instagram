<html layout:decorate="~{Layout/layout_main}" xmlns:th="http://www.thymeleaf.org">
<head>
    <link rel="stylesheet" type="text/css" th:href="@{/dm/css/DirectInbox.css}">
    <title>User Page</title>
</head>
<div layout:fragment="content">
    <div class="d-flex">
        <div class="main-content d-flex">
            <div class="col-3" style="width: 398px; overflow-y: scroll">
                <ul>
                    <li th:each="room:${roomList}">
                        <a th:href="@{|/direct/t/${room.id}|}"
                           th:text="${room.name}"></a>
                    </li>
                </ul>
            </div>
            <div class="col-9">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <div>
                    <div class="d-flex align-items-center border-bottom" style="height: 75px; min-height: 75px; padding: 0 16px">
                        <div th:each="member : ${nowRoomDTO.members}">
                            <a th:href="@{|/member/page/${member.getValue().username}|}">
                                <div th:if="${member.getKey() != loginMember.username}"
                                     style="position: relative; width: 44px; height: 44px; margin: 6px">
                                    <img th:if="${member.getValue().image == null}"
                                         src="/files/designImg/noneuser.png"
                                         class="shadow-sm rounded-circle text-center"
                                         style="position: absolute; top: 0; left: 0; transform: translate(50,50); width: 100%; height: 100%; object-fit: cover; margin: auto">
                                    <img th:unless="${member.getValue().image == null}"
                                         th:src="@{|/resources/${member.getValue().image.name}|}"
                                         class="shadow-sm rounded-circle text-center"
                                         style="position: absolute; top: 0; left: 0; transform: translate(50,50); width: 100%; height: 100%; object-fit: cover; margin: auto">
                                </div>
                            </a>
                        </div>
                        <span style="padding: 6px; font-size: 16px;" class="fw-bold" th:text="${nowRoomDTO.room.name}"></span>
                    </div>
                    <input type="hidden" id="room-id" th:value="${nowRoomDTO.room.id}">
                    <input type="hidden" id="loginUser-username" th:value="${loginMember.username}">
                </div>
                <div class="d-flex justify-content-center align-items-center" style="height: calc(100vh - 75px - 78px);">
                    <div id="msg-container" class="w-100 h-100" style="overflow-y: scroll;">
                        <div class="msgArea">
                            <div th:each="msg : ${messageList}">
                                <div th:if="${msg.member.username == loginMember.username}" class="p-4">
                                    <div class="d-flex justify-content-end">
                                        <div>
                                            <div class="d-flex align-items-center my-2">
                                                <div class="rounded-5 bg-primary text-light p-2 px-3"
                                                     th:text="${msg.message.content}">
                                                </div>
                                                <div class="flex-fill">
                                                </div>
                                            </div>
                                            <div class="read-check my-2 text-end" th:text="${msg.seeMember}"></div>
                                        </div>
                                    </div>
                                </div>
                                <div th:unless="${msg.member.username == loginMember.username}" class="p-4">
                                    <div class="my-2" th:text="${msg.member.username}"></div>
                                    <div class="d-flex align-items-center my-2">
                                        <a th:href="@{|/member/page/${msg.member.username}|}">
                                            <div style="position: relative; width: 3rem; height: 3rem;">
                                                <img th:if="${msg.member.image == null}"
                                                     src="/files/designImg/noneuser.png"
                                                     class="shadow-sm rounded-circle text-center"
                                                     style="position: absolute; top: 0; left: 0; transform: translate(50,50); width: 100%; height: 100%; object-fit: cover; margin: auto">
                                                <img th:unless="${msg.member.image == null}"
                                                     th:src="@{|/resources/${msg.member.image.name}|}"
                                                     class="shadow-sm rounded-circle text-center"
                                                     style="position: absolute; top: 0; left: 0; transform: translate(50,50); width: 100%; height: 100%; object-fit: cover; margin: auto">
                                            </div>
                                        </a>
                                        <div class="mx-3 rounded-5 p-2 px-3" style="background: #b7b7b7" th:text="${msg.message.content}">
                                        </div>
                                        <div class="flex-fill">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="d-flex align-items-center" style="height: 78px; min-height: 78px">
                    <div class="d-flex w-100 px-4 pe-5">
                        <div class="me-2 flex-fill">
                            <input type="text" placeholder="보낼 메세지를 입력하세요." class="content form-control">
                        </div>
                        <div class="me-2">
                            <button type="button" value="전송" class="sendBtn btn btn-primary" onclick="sendMsg()">전송</button>
                        </div>
                        <div>
                            <button type="button" value="방나가기" class="quit btn btn-primary" onclick="quit()">방 나가기</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        scrollEnd();

        var roomId = document.getElementById('room-id').value;
        var username = document.getElementById('loginUser-username').value;
        let msgArea = document.querySelector('.msgArea');
        var connectMember = [];

        function enterRoom(socket) {

            var enterMsg =
                {
                    "type": "ENTER",
                    "roomId": roomId,
                    "sender": username,
                };

            socket.send(JSON.stringify(enterMsg));

            const csrfToken = document.querySelector('input[name="_csrf"]').value;
            fetch('/room/readMessage',
                {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': csrfToken
                    },
                    body: JSON.stringify(enterMsg)
                })
        }

        let socket = new WebSocket("ws://localhost:8888/ws/chat");

        socket.onopen = function (e) {
            
            console.log('open server!')
            enterRoom(socket);
        };

        socket.onclose = function (e) {
            console.log('disconnet');
        }

        socket.onerror = function (e) {

            console.log(e);
        }

        //메세지 수신했을 때 이벤트.
        socket.onmessage = function (e) {
            

            console.log(e.data);

            var data = JSON.parse(e.data);

            if (data.type === 'TALK' && data.sender === username) {
                createMineMessage(data);
            } else if (data.type === 'TALK' && data.sender !== username) {
                createMessage(data);
            } else if (data.type === 'ENTER' && data.sender !== username) {
                sendConnectState(socket);

                connectMember.push(data.sender);

                readMessage(data);
            } else if (data.type === 'CONNECT' && data.sender !== username) {
                connectMember.push(data.sender);
            } else if (data.type === 'DISCONNECT' && data.sender !== username) {
                let index = connectMember.indexOf(data.sender);
                if (index !== -1) {
                    connectMember.splice(index, 1);
                }
            }

        }

        function sendConnectState(socket) {
            
            var enterMsg =
                {
                    "type": "CONNECT",
                    "roomId": roomId,
                    "sender": username,
                };

            socket.send(JSON.stringify(enterMsg));
        }

        function readMessage(data) {
            var readCheck = document.getElementsByClassName('read-check');

            for (var i = 0; i < readCheck.length; i++) {
                readCheck.item(i).textContent = data.sender + '님이 확인함';
            }
        }

        function createMineMessage(data) {

            var read = '';
            for (var i = 0; i < connectMember.length; i++) {
                read += connectMember[i] + '님';
                if (i !== connectMember.length - 1) {
                    read += ',';
                } else {
                    read += '이 확인함';
                }
            }

            let newMsg = document.createElement('div');
            newMsg.innerHTML =
                '                           <div class="p-4">\n' +
                '                                <div class="d-flex justify-content-end">\n' +
                '                                    <div>\n' +
                '                                        <div class="d-flex align-items-center my-2">\n' +
                '                                            <div class="rounded-5 bg-primary text-light p-2 px-3">\n' +
                data.msg +
                '                                            </div>\n' +
                '                                            <div class="flex-fill">\n' +
                '                                            </div>\n' +
                '                                        </div>\n' +
                '                                        <div class="read-check my-2 text-end">\n' +
                read +
                '                                        </div>\n' +
                '                                    </div>\n' +
                '                                </div>\n' +
                '                            </div>';
            msgArea.appendChild(newMsg);

            scrollEnd();
        }

        function scrollEnd()
        {
            var objDiv = document.getElementById("msg-container");
            objDiv.scrollTop = objDiv.scrollHeight;
        }


        function createMessage(data) {
            
            let newMsg = document.createElement('div');

            var members = [[${nowRoomDTO.members}]];
            var imgSrc = '';
            var img = members[data.sender].image;
            if (img === null) {
                imgSrc = 'src="/files/designImg/noneuser.png"\n';
            } else {
                imgSrc = 'src="/resources/' + img.name + '"\n';
            }
            newMsg.innerHTML =
                '                            <div class="p-4">\n' +
                '                                <div class="my-2">\n' +
                data.sender +
                '                                </div>\n' +
                '                                <div class="d-flex align-items-center my-2">\n' +
                '                                   <a href="/member/page/' + data.sender + '">\n' +
                '                                       <div style="position: relative; width: 3rem; height: 3rem;">\n' +
                '                                           <img ' + imgSrc +
                '                                               class="shadow-sm rounded-circle text-center"\n' +
                '                                               style="position: absolute; top: 0; left: 0; transform: translate(50,50); width: 100%; height: 100%; object-fit: cover; margin: auto">\n' +
                '                                       </div>\n' +
                '                                   </a>\n' +
                '                                   <div class="mx-3 rounded-5 p-2 px-3" style="background: #b7b7b7">\n' +
                data.msg +
                '                                   </div>\n' +
                '                                   <div class="flex-fill">\n' +
                '                                    </div>\n' +
                '                                </div>\n' +
                '                            </div>';
            msgArea.appendChild(newMsg);

            scrollEnd();
        }


        //메세지 보내기 버튼 눌렀을 떄..
        function sendMsg() {

            const csrfToken = document.querySelector('input[name="_csrf"]').value;

            var content = document.querySelector('.content');
            var talkMsg = {
                "type": "TALK",
                "roomId": roomId,
                "sender": username,
                "msg": content.value
            };

            fetch('/message/create',
                {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': csrfToken
                    },
                    body: JSON.stringify(talkMsg)
                })


            socket.send(JSON.stringify(talkMsg));

            debugger;
            content.value = '';
        }

        function quit() {
            sendDisconnectState(socket);

            const csrfToken = document.querySelector('input[name="_csrf"]').value;

            
            var quitMsg = {
                "type": "QUIT",
                "roomId": roomId,
                "sender": username
            };

            fetch('/room/readMessage',
                {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': csrfToken
                    },
                    body: JSON.stringify(quitMsg)
                })

            socket.send(JSON.stringify(quitMsg));
            socket.close();
        }

        function sendDisconnectState(socket) {
            var enterMsg =
                {
                    "type": "DISCONNECT",
                    "roomId": roomId,
                    "sender": username,
                };

            socket.send(JSON.stringify(enterMsg));
        }

        window.addEventListener('beforeunload', function (e) {
            quit();
        });
    </script>
</div>
</html>