<html layout:decorate="~{Layout/layout_main}" xmlns:th="http://www.thymeleaf.org">
<head>
    <link rel="stylesheet" type="text/css" th:href="@{/dm/css/DirectInbox.css}">
    <title>User Page</title>
</head>
<div layout:fragment="content">
    <div class="d-flex">
        <div class="main-content d-flex" style="margin-left: 4.5rem;">
            <div class="col-3" style="width: 398px; overflow-y: scroll">
                <ul>
                    <li th:each="dto:${roomList}">
                        <a th:href="@{|/direct/t/${dto.room.id}|}"
                           th:text="${dto.name}"></a>
                    </li>
                </ul>
            </div>
            <div class="flex-fill">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <div>
                    <div class="d-flex align-items-center border-bottom"
                         style="height: 75px; min-height: 75px; padding: 0 16px">
                        <div th:each="member : ${nowRoomDTO.members}">
                            <a th:href="@{|/member/page/${member.getValue().username}|}">
                                <div th:if="${member.getKey() != loginMember.username}"
                                     style="position: relative; width: 44px; height: 44px; margin: 6px">
                                    <img th:if="${member.getValue().image == null}"
                                         src="/files/designImg/noneuser.png"
                                         class="shadow-sm rounded-circle text-center"
                                         style="position: absolute; top: 0; left: 0; transform: translate(50,50); width: 100%; height: 100%; object-fit: cover; margin: auto">
                                    <img th:unless="${member.getValue().image == null}"
                                         th:src="@{|/resources/${member.getValue().image.name}|}"
                                         class="shadow-sm rounded-circle text-center"
                                         style="position: absolute; top: 0; left: 0; transform: translate(50,50); width: 100%; height: 100%; object-fit: cover; margin: auto">
                                </div>
                            </a>
                        </div>
                        <span style="padding: 6px; font-size: 16px;" class="fw-bold"
                              th:text="${nowRoomDTO.name}"></span>
                    </div>
                    <input type="hidden" id="room-id" th:value="${nowRoomDTO.room.id}">
                    <input type="hidden" id="loginUser-username" th:value="${loginMember.username}">
                </div>
                <div id="msg-area-container" class="d-flex justify-content-center align-items-center"
                     style="height: calc(100vh - 75px - 78px);">
                    <div class="w-100 h-100 d-flex align-items-center justify-content-center" id="spin-container">
                        <span class="spinner-border">

                        </span>
                    </div>
                    <div id="msg-container" class="w-100 h-100" style="overflow-y: scroll; display: none;">
                        <div class="msgArea">
                            <div style="height: 16px">

                            </div>
                            <div th:each="msg, iterStat : ${messageList}">
                                <div th:id="'msg'+${msg.id}" th:if="${msg.member.username == loginMember.username}"
                                     style="margin-top: 7px;">
                                    <div class="d-flex justify-content-end">
                                        <div>
                                            <div th:if="${msg.dataType == 1 && msg.commented}"
                                                 style="margin-right: 6px; margin-bottom: 6px;">
                                                <div th:if="${msg.comment.messageMap.member.username == loginMember.username}">
                                                    <div class="text-end mb-2"
                                                         style="font-size: 12px; color: #797979; padding: 10px 8px 0 0">
                                                        회원님이 자신에게 보낸 답장
                                                    </div>
                                                </div>
                                                <div th:unless="${msg.comment.messageMap.member.username == loginMember.username}">
                                                    <div class="text-end mb-2"
                                                         style="font-size: 12px; color: #797979; padding: 10px 8px 0 0"
                                                         th:text="@{|회원님이 ${msg.comment.messageMap.member.nickname == ''?msg.comment.messageMap.member.username:msg.comment.messageMap.member.nickname}님에게 보낸 답장|}">
                                                    </div>
                                                </div>
                                                <div>
                                                    <div class="d-flex justify-content-end">
                                                        <div th:if="${msg.comment.messageMap.dataType == 1}"
                                                             style="background:#efefef; font-size: 14px; padding: 8px 12px"
                                                             class="rounded-5 mx-2"
                                                             th:text="${msg.message.content}">
                                                        </div>

                                                        <div th:if="${msg.comment.messageMap.dataType == 2}"
                                                             onclick="clickShowImage(this)"
                                                             th:data-id="${msg.image.name}"
                                                             class="mx-2" type="button"
                                                             data-bs-toggle="modal" data-bs-target="#showDataModal">
                                                            <img th:src="@{|/resources/${msg.image.name}|}"
                                                                 style="width: 10rem; height: auto; border-radius: 22px">
                                                        </div>

                                                        <div th:if="${msg.comment.messageMap.dataType == 3}"
                                                             th:data-id="${msg.video.name}"
                                                             onclick="clickShowVideo(this)"
                                                             type="button"
                                                             data-bs-toggle="modal" data-bs-target="#showDataModal"
                                                             class="mx-2 d-flex justify-content-end position-relative">
                                                            <span style="position: absolute;">
                                                                <img height="45" width="45" alt=""
                                                                     src="/files/designImg/playButton.png">
                                                            </span>
                                                            <video style="width: 10rem; height: auto; border-radius: 22px"
                                                                   th:src="@{|/resources/${msg.video.name}|}">
                                                            </video>
                                                        </div>

                                                        <div style="background:#efefef; width: 4px; min-height: 34px">
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="d-flex align-items-center justify-content-end">
                                                <div class="d-flex align-items-center" style="margin-right: 5px">
                                                    <div>
                                                        <button th:id="${msg.id}" data-user="true" class="border-0"
                                                                style="background: none; color: #9f9f9f"
                                                                data-bs-container="body" data-bs-toggle="popover"
                                                                data-bs-placement="top" data-bs-target="popover"
                                                                data-bs-html="true">
                                                            <svg aria-label="더 보기" fill="currentColor" height="16"
                                                                 role="img" viewBox="0 0 24 24" width="16"><title>더
                                                                보기</title>
                                                                <circle cx="12" cy="12" r="1.5"></circle>
                                                                <circle cx="6" cy="12" r="1.5"></circle>
                                                                <circle cx="18" cy="12" r="1.5"></circle>
                                                            </svg>
                                                        </button>
                                                    </div>

                                                    <div style="margin: 8px; color: #9f9f9f">
                                                        <button th:id="${msg.id}" data-user="true"
                                                                th:data-user-name="${msg.member.username}"
                                                                th:data-msg-content="${msg.dataType == 1 && msg.commented}?${msg.comment.message.content}:(${msg.dataType == 1 && !msg.commented}? ${msg.message.content} : '')"
                                                                th:data-type="${msg.dataType}"
                                                                class="border-0" onclick="clickComment(this)"
                                                                style="background: none; color: #9f9f9f"
                                                                data-bs-container="body">
                                                            <svg aria-label="답장" fill="currentColor" height="16"
                                                                 role="img" viewBox="0 0 24 24" width="16"><title>
                                                                답장</title>
                                                                <path d="M14 8.999H4.413l5.294-5.292a1 1 0 1 0-1.414-1.414l-7 6.998c-.014.014-.019.033-.032.048A.933.933 0 0 0 1 9.998V10c0 .027.013.05.015.076a.907.907 0 0 0 .282.634l6.996 6.998a1 1 0 0 0 1.414-1.414L4.415 11H14a7.008 7.008 0 0 1 7 7v3.006a1 1 0 0 0 2 0V18a9.01 9.01 0 0 0-9-9Z"></path>
                                                            </svg>
                                                        </button>
                                                    </div>
                                                    <div style="margin: 8px; color: #9f9f9f">
                                                        <svg aria-label="공감" fill="currentColor" height="16" role="img"
                                                             viewBox="0 0 24 24" width="16"><title>공감</title>
                                                            <path d="M15.83 10.997a1.167 1.167 0 1 0 1.167 1.167 1.167 1.167 0 0 0-1.167-1.167Zm-6.5 1.167a1.167 1.167 0 1 0-1.166 1.167 1.167 1.167 0 0 0 1.166-1.167Zm5.163 3.24a3.406 3.406 0 0 1-4.982.007 1 1 0 1 0-1.557 1.256 5.397 5.397 0 0 0 8.09 0 1 1 0 0 0-1.55-1.263ZM12 .503a11.5 11.5 0 1 0 11.5 11.5A11.513 11.513 0 0 0 12 .503Zm0 21a9.5 9.5 0 1 1 9.5-9.5 9.51 9.51 0 0 1-9.5 9.5Z"></path>
                                                        </svg>
                                                    </div>
                                                </div>
                                                <div th:if="${msg.dataType == 1 && !msg.commented}"
                                                     class="rounded-5 text-light"
                                                     style="padding: 7px 12px; background: #3797F0; font-size: 15px"
                                                     th:text="${msg.message.content}">
                                                </div>
                                                <div th:if="${msg.dataType == 1 && msg.commented}">
                                                    <div class="rounded-5 text-light"
                                                         style="padding: 7px 12px; background: #3797F0; font-size: 15px"
                                                         th:text="${msg.comment.message.content}">
                                                    </div>
                                                </div>
                                                <div th:if="${msg.dataType == 2}"
                                                     th:data-id="${msg.image.name}"
                                                     onclick="clickShowImage(this)"
                                                     type="button"
                                                     data-bs-toggle="modal" data-bs-target="#showDataModal">
                                                    <img th:src="@{|/resources/${msg.image.name}|}"
                                                         style="width: 15rem; height: auto; border-radius: 22px 4px 22px 22px">
                                                </div>
                                                <div th:if="${msg.dataType == 3}"
                                                     th:data-id="${msg.video.name}"
                                                     onclick="clickShowVideo(this)"
                                                     type="button"
                                                     data-bs-toggle="modal" data-bs-target="#showDataModal"
                                                     class="d-flex justify-content-end position-relative">
                                                    <span style="position: absolute;">
                                                        <img height="45" width="45" alt=""
                                                             src="/files/designImg/playButton.png">
                                                    </span>
                                                    <video style="width: 15rem; height: auto; border-radius: 22px 4px 22px 22px"
                                                           th:src="@{|/resources/${msg.video.name}|}">
                                                    </video>
                                                </div>
                                            </div>
                                            <div th:classappend="${iterStat.last}?'read-check'" class="text-end"
                                                 th:text="${iterStat.last}?${msg.seeMember}:''"></div>
                                        </div>
                                        <div style="width: 16px">

                                        </div>
                                    </div>
                                </div>
                                <div th:unless="${msg.member.username == loginMember.username}"
                                     style="margin-top: 7px;"
                                     th:id="'msg'+${msg.id}">
                                    <div th:if="${!msg.commented}"
                                         style="margin-left: 44px; margin-top:10px; padding: 0 0 6px 12px; font-size: 12px; color: #737373"
                                         th:text="${msg.member.nickname==''}?${msg.member.username}:${msg.member.nickname}"></div>

                                    <div th:if="${msg.dataType == 1 && msg.commented}"
                                         style="margin-right: 6px; margin-left: 44px; margin-bottom: 6px;">
                                        <div th:if="${msg.comment.messageMap.member.username == msg.member.username}"
                                             style="padding: 10px 0 0 8px;">
                                            <div th:if="${msg.member.nickname == ''}"
                                                 class="mb-2" style="font-size: 12px; color: #797979"
                                                 th:text="@{|${msg.member.username}님이 자신에게 보낸 답장|}">
                                            </div>
                                            <div th:unless="${msg.member.nickname == ''}"
                                                 class="mb-2" style="font-size: 12px; color: #797979"
                                                 th:text="@{|${msg.member.nickname}님이 자신에게 보낸 답장|}">
                                            </div>
                                        </div>
                                        <div th:unless="${msg.comment.messageMap.member.username == msg.member.username}"
                                             style="padding: 10px 0 0 8px;">
                                            <div th:if="${msg.comment.messageMap.member.username == loginMember.username}">
                                                <div class="mb-2" style="font-size: 12px; color: #797979"
                                                     th:text="@{|${msg.member.nickname==''?msg.member.username:msg.member.nickname}님이 회원님에게 보낸 답장|}">
                                                </div>
                                            </div>
                                            <div th:unless="${msg.comment.messageMap.member.username == loginMember.username}">
                                                <div class="mb-2" style="font-size: 12px; color: #797979"
                                                     th:text="@{|${msg.member.nickname==''?msg.member.username:msg.member.nickname}님이
                                                     ${msg.comment.messageMap.member.nickname==''?msg.comment.messageMap.member.username:msg.comment.messageMap.member.nickname}님에게 보낸 답장|}">
                                                </div>
                                            </div>
                                        </div>
                                        <div>
                                            <div class="d-flex">
                                                <div style="background:#efefef; width: 4px; min-height: 34px">
                                                </div>
                                                <div th:if="${msg.comment.messageMap.dataType == 1}"
                                                     style="background:#efefef; font-size: 14px; padding: 8px 12px"
                                                     class="rounded-5 mx-2"
                                                     th:text="${msg.message.content}">
                                                </div>

                                                <div th:if="${msg.comment.messageMap.dataType == 2}"
                                                     onclick="clickShowImage(this)"
                                                     th:data-id="${msg.image.name}"
                                                     class="mx-2" type="button"
                                                     data-bs-toggle="modal" data-bs-target="#showDataModal">
                                                    <img th:src="@{|/resources/${msg.image.name}|}"
                                                         style="width: 10rem; height: auto; border-radius: 22px">
                                                </div>

                                                <div th:if="${msg.comment.messageMap.dataType == 3}"
                                                     th:data-id="${msg.video.name}"
                                                     onclick="clickShowVideo(this)"
                                                     type="button"
                                                     data-bs-toggle="modal" data-bs-target="#showDataModal"
                                                     class="mx-2 d-flex justify-content-end position-relative">
                                                            <span style="position: absolute;">
                                                                <img height="45" width="45" alt=""
                                                                     src="/files/designImg/playButton.png">
                                                            </span>
                                                    <video style="width: 10rem; height: auto; border-radius: 22px"
                                                           th:src="@{|/resources/${msg.video.name}|}">
                                                    </video>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="d-flex" th:classappend="${msg.dataType == 1}?'align-items-center'">
                                        <a th:href="@{|/member/page/${msg.member.username}|}">
                                            <div style="position: relative; width: 28px; height: 28px; margin:0 8px 0 14px">
                                                <img th:if="${msg.member.image == null}"
                                                     src="/files/designImg/noneuser.png"
                                                     class="shadow-sm rounded-circle text-center"
                                                     style="position: absolute; top: 0; left: 0; transform: translate(50,50); width: 100%; height: 100%; object-fit: cover; margin: auto">
                                                <img th:unless="${msg.member.image == null}"
                                                     th:src="@{|/resources/${msg.member.image.name}|}"
                                                     class="shadow-sm rounded-circle text-center"
                                                     style="position: absolute; top: 0; left: 0; transform: translate(50,50); width: 100%; height: 100%; object-fit: cover; margin: auto">
                                            </div>
                                        </a>
                                        <div th:if="${msg.dataType == 1 && !msg.commented}" th:id="@{|text${msg.id}|}"
                                             class="rounded-5"
                                             style="background:#efefef; font-size: 15px; padding: 7px 12px; "
                                             th:text="${msg.message.content}">
                                        </div>
                                        <div th:if="${msg.dataType == 1 && msg.commented}" th:id="@{|text${msg.id}|}"
                                             class="rounded-5"
                                             style="background:#efefef; font-size: 15px; padding: 7px 12px;"
                                             th:text="${msg.comment.message.content}">
                                        </div>
                                        <div th:if="${msg.dataType == 2}"
                                             th:data-id="${msg.image.name}"
                                             onclick="clickShowImage(this)"
                                             type="button"
                                             data-bs-toggle="modal" data-bs-target="#showDataModal">
                                            <img th:src="@{|/resources/${msg.image.name}|}"
                                                 style="width: 15rem; height: auto; border-radius: 4px 22px 22px 22px">
                                        </div>
                                        <div th:if="${msg.dataType == 3}" type="button"
                                             th:data-id="${msg.video.name}"
                                             onclick="clickShowVideo(this)"
                                             data-bs-toggle="modal" data-bs-target="#showDataModal"
                                             class="d-flex justify-content-end position-relative">
                                            <span style="position: absolute;">
                                                <img height="45" width="45" alt=""
                                                     src="/files/designImg/playButton.png">
                                            </span>
                                            <video style="width: 15rem; height: auto; border-radius: 4px 22px 22px 22px"
                                                   th:src="@{|/resources/${msg.video.name}|}">
                                            </video>
                                        </div>
                                        <div class="d-flex align-items-center" style="margin-left: 5px">
                                            <div style="margin: 8px; color: #9f9f9f">
                                                <svg aria-label="공감" fill="currentColor" height="16" role="img"
                                                     viewBox="0 0 24 24" width="16"><title>공감</title>
                                                    <path d="M15.83 10.997a1.167 1.167 0 1 0 1.167 1.167 1.167 1.167 0 0 0-1.167-1.167Zm-6.5 1.167a1.167 1.167 0 1 0-1.166 1.167 1.167 1.167 0 0 0 1.166-1.167Zm5.163 3.24a3.406 3.406 0 0 1-4.982.007 1 1 0 1 0-1.557 1.256 5.397 5.397 0 0 0 8.09 0 1 1 0 0 0-1.55-1.263ZM12 .503a11.5 11.5 0 1 0 11.5 11.5A11.513 11.513 0 0 0 12 .503Zm0 21a9.5 9.5 0 1 1 9.5-9.5 9.51 9.51 0 0 1-9.5 9.5Z"></path>
                                                </svg>
                                            </div>
                                            <div style="margin: 8px; color: #9f9f9f">
                                                <button th:id="${msg.id}" data-user="false"
                                                        th:data-user-name="${msg.member.username}"
                                                        th:data-msg-content="${msg.dataType == 1 && msg.commented}?${msg.comment.message.content}:(${msg.dataType == 1 && !msg.commented}? ${msg.message.content} : '')"
                                                        th:data-type="${msg.dataType}"
                                                        onclick="clickComment(this)" class="border-0"
                                                        style="background: none; color: #9f9f9f"
                                                        data-bs-container="body">
                                                    <svg aria-label="답장" fill="currentColor" height="16" role="img"
                                                         viewBox="0 0 24 24" width="16"><title>답장</title>
                                                        <path d="M14 8.999H4.413l5.294-5.292a1 1 0 1 0-1.414-1.414l-7 6.998c-.014.014-.019.033-.032.048A.933.933 0 0 0 1 9.998V10c0 .027.013.05.015.076a.907.907 0 0 0 .282.634l6.996 6.998a1 1 0 0 0 1.414-1.414L4.415 11H14a7.008 7.008 0 0 1 7 7v3.006a1 1 0 0 0 2 0V18a9.01 9.01 0 0 0-9-9Z"></path>
                                                    </svg>
                                                </button>
                                            </div>
                                            <div>
                                                <button th:id="${msg.id}" data-user="false"
                                                        th:data-type="${msg.dataType}" class="border-0"
                                                        style="background: none; color: #9f9f9f"
                                                        data-bs-container="body" data-bs-toggle="popover"
                                                        data-bs-placement="top" data-bs-target="popover"
                                                        data-bs-html="true">
                                                    <svg aria-label="더 보기" fill="currentColor" height="16" role="img"
                                                         viewBox="0 0 24 24" width="16"><title>더 보기</title>
                                                        <circle cx="12" cy="12" r="1.5"></circle>
                                                        <circle cx="6" cy="12" r="1.5"></circle>
                                                        <circle cx="18" cy="12" r="1.5"></circle>
                                                    </svg>
                                                </button>
                                            </div>
                                        </div>

                                        <div class="flex-fill">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="comment-msg-area" data-id="" class="border-top hidden" style="padding: 10px 15px 3px">
                    <div class="d-flex justify-content-between">
                        <div class="d-flex">
                            <div id="comment-msg-name" class="fw-bold" style="font-size: 14px">

                            </div>
                            <div id="comment-user" style="font-size: 14px">
                                님에게 답장 보내는 중
                            </div>
                        </div>
                        <div onclick="clickCommentCansel()">
                            <svg aria-label="답장 취소" height="12" role="img" viewBox="0 0 24 24" width="12"><title>답장
                                취소</title>
                                <polyline fill="none" points="20.643 3.357 12 12 3.353 20.647" stroke="currentColor"
                                          stroke-linecap="round" stroke-linejoin="round" stroke-width="3"></polyline>
                                <line fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
                                      stroke-width="3" x1="20.649" x2="3.354" y1="20.649" y2="3.354"></line>
                            </svg>
                        </div>
                    </div>
                    <div id="comment-msg-data" style="color: #7b848a; font-size: 13px">

                    </div>
                </div>
                <div class="d-flex align-items-center" style="height: 78px; min-height: 78px">
                    <div class="d-flex w-100 px-4">
                        <div class="me-2 flex-fill">
                            <input id="msg-send-input" name="msg-send-input" type="text"
                                   data-type="msg"
                                   placeholder="보낼 메세지를 입력하세요."
                                   class="content form-control" oninput="inputMessage(this)"
                                   onkeydown="inputEnter(event)">
                        </div>
                        <div class="me-2">
                            <button type="button" value="전송" id="send-btn" disabled
                                    class="sendBtn btn btn-primary" onclick="sendMsg(this)">전송
                            </button>
                        </div>
                        <div>
                            <button type="button" value="파일" id="file-send-btn"
                                    class="quit btn btn-primary" onclick="clickFile()">파일
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal modal-lg fade" id="showDataModal" tabindex="-1" aria-labelledby="exampleModalLabel"
             aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-body">
                        <video id="modal-video" controls autoplay muted class="w-100 h-auto hidden"></video>
                        <img id="modal-image" alt="에러" class="w-100 h-auto hidden">
                    </div>
                </div>
            </div>
        </div>

        <input type="file" accept="image/jpeg, image/png, video/mp4" class="visually-hidden"
               id="file-sender" multiple
               name="file-sender" onchange="directFile(this);">
    </div>

    <script th:inline="javascript">


        
        let popoverTriggerList = document.querySelectorAll('[data-bs-toggle="popover"]');
        let popoverList = [...popoverTriggerList].map(popoverTriggerEl => new bootstrap.Popover(popoverTriggerEl));

        var dynamicContent = '';
        for (var z = 0; z < popoverList.length; z++) {
            var popover = popoverTriggerList.item(z);
            if (popover.getAttribute('data-user') === 'true') {
                dynamicContent = '<div><div id="' + popover.id + '" class="delete-msg">전송 취소</div></div>';
                popover.setAttribute('data-bs-content', dynamicContent);
            } else {
                if (popover.getAttribute('data-type') === '1') {
                    dynamicContent = '<div class="d-flex">' +
                        '<div id="' + popover.id + '" class="resend-msg me-2">전달</div>' +
                        '<div id="' + popover.id + '" class="copy-msg">복사</div>' +
                        '</div>';
                } else {
                    dynamicContent = '<div class="d-flex"><div id="' + popover.id + '" class="resend-msg">전달</div></div>';
                }

                popover.setAttribute('data-bs-content', dynamicContent);
            }
        }

        deleteMsgTrigger();
        resendMsgTrigger();
        copyMsgTrigger();

        function popoverChange() {


            const a = document.querySelectorAll('[data-bs-toggle="popover"]');
            var d = a.length - 1;
            const newPopoverTriggerList = document.querySelectorAll('[data-bs-toggle="popover"]').item(d);
            const newPopoverList = [newPopoverTriggerList].map(popoverTriggerEl => new bootstrap.Popover(popoverTriggerEl));

            popoverList.push(newPopoverList);

            var dynamicContent = '<div><div id="' + newPopoverTriggerList.id + '" class="delete-msg">전송 취소</div></div>';
            newPopoverTriggerList.setAttribute('data-bs-content', dynamicContent);
        }

        function deleteMsgTrigger() {
            $(document).on('click', '.delete-msg', function () {
                // 삭제 동작 수행
                var popID = $(this).parent().parent().parent().attr('id');
                var msgID = $(this).attr('id');
                // Popover 닫기 (선택 사항)
                deleteMsg(msgID, popID);

                closeCommentArea();
            });
        }

        function closeCommentArea() {
            document.getElementById('msg-send-input').dataset.type = 'msg';
            var area = document.getElementById('comment-msg-area');
            area.dataset.id = '';

            if (!area.classList.contains("hidden")) {
                area.classList.add("hidden");

                var msgArea = document.getElementById('msg-area-container');
                msgArea.style.height = 'calc(100vh - 75px - 78px)';
            }
            document.getElementById('file-send-btn').disabled = false;
        }

        function openCommentArea(id) {
            document.getElementById('msg-send-input').dataset.type = 'comment';
            var area = document.getElementById('comment-msg-area');
            area.dataset.id = id;

            if (area.classList.contains("hidden")) {
                area.classList.remove("hidden");

                var msgArea = document.getElementById('msg-area-container');
                msgArea.style.height = 'calc(100vh - 75px - 135.5px)';
            }

            document.getElementById('file-send-btn').disabled = true;
        }


        function resendMsgTrigger() {
            $(document).on('click', '.resend-msg', function () {
                // 삭제 동작 수행
                var popID = $(this).parent().parent().parent().attr('id');
                var msgID = $(this).attr('id');
                // Popover 닫기 (선택 사항)
                resendMsg(msgID, popID);
            });
        }

        function copyMsgTrigger() {

            $(document).on('click', '.copy-msg', function () {
                // 삭제 동작 수행
                var msgID = $(this).attr('id');
                // Popover 닫기 (선택 사항)
                copyMsg(msgID);
            });
        }

        function clickComment(data) {

            openCommentArea(data.id);

            var name = document.getElementById('comment-msg-name');

            
            if (data.dataset.user === 'true') {
                name.textContent = '';
                document.getElementById('comment-user').textContent = "나에게 답장 보내는 중";
            } else {
                document.getElementById('comment-user').textContent = "님에게 답장 보내는 중";
                name.textContent = data.dataset.userName;
            }

            var content = document.getElementById('comment-msg-data');


            var dataType = data.dataset.type;
            if (dataType === '1') {
                content.textContent = data.dataset.msgContent;
            } else if (dataType === '2') {
                content.textContent = '이미지';
            } else if (dataType === '3') {
                content.textContent = '동영상';
            }
        }

        function clickCommentCansel() {
            closeCommentArea();
        }

        var sideCheck = document.getElementById('expand-direct-menu');
        sideCheck.checked = true;

        var sidebar = document.getElementById('side_bar');
        sidebar.style.width = '4.5rem';

        var sidemenu = document.getElementById('side_menu');
        sidemenu.style.width = '4.5rem';

        setTimeout(() => {

            document.getElementById('spin-container').remove();
            document.getElementById("msg-container").style.display = 'inline';
            scrollEnd();
        }, 1200);

        var roomId = document.getElementById('room-id').value;
        var username = document.getElementById('loginUser-username').value;
        let msgArea = document.querySelector('.msgArea');
        var connectMember = [];

        function inputMessage(input) {
            var sendBtn = document.getElementById('send-btn');
            sendBtn.disabled = input.value === '';
        }

        function inputEnter(event) {
            var sendBtn = document.getElementById('send-btn');
            if (event.key === 'Enter') {

                if (!sendBtn.disabled) {
                    sendBtn.click();
                }
            }
        }

        function enterRoom(socket) {

            var enterMsg =
                {
                    "type": "ENTER",
                    "roomId": roomId,
                    "sender": username,
                };

            socket.send(JSON.stringify(enterMsg));

            const csrfToken = document.querySelector('input[name="_csrf"]').value;
            fetch('/direct/quit',
                {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': csrfToken
                    },
                    body: JSON.stringify(enterMsg)
                })
        }

        let socket = new WebSocket("ws://localhost:8888/ws/chat");

        socket.onopen = function (e) {

            console.log('open server!')
            enterRoom(socket);
        };

        socket.onclose = function (e) {
            console.log('disconnet');
        }

        socket.onerror = function (e) {

            console.log(e);
        }

        //메세지 수신했을 때 이벤트.
        socket.onmessage = function (e) {

            const csrfToken = document.querySelector('input[name="_csrf"]').value;

            console.log(e.data);
            debugger;


            var data = JSON.parse(e.data);
            if (data.type === 'TALK' && data.sender === username) {
                createMineMessage(data);
            } else if (data.type === 'TALK' && data.sender !== username) {
                createMessage(data);

                setTimeout(() => {
                    fetch('/direct/readMessage',
                        {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRF-TOKEN': csrfToken
                            },
                            body: JSON.stringify(data)
                        });
                }, 100);

            } else if (data.type === 'ENTER' && data.sender !== username) {
                sendConnectState(socket);

                if(!connectMember.includes(data.sender))
                {
                    connectMember.push(data.sender);
                }

                readMessage(data);
            } else if (data.type === 'CONNECT' && data.sender !== username) {
                if(!connectMember.includes(data.sender))
                {
                    connectMember.push(data.sender);
                }
            } else if (data.type === 'DISCONNECT' && data.sender !== username) {
                let index = connectMember.indexOf(data.sender);
                if (index !== -1) {
                    connectMember.splice(index, 1);
                }
            } else if (data.type === 'DELETE' && data.sender !== username) {
                var msgContainer = document.getElementById('msg' + data.id);

                msgContainer.remove();
            }

        }

        function clickShowImage(div) {
            var image = document.getElementById('modal-image');
            image.setAttribute('src', '/resources/' + div.dataset.id);
            image.classList.remove('hidden');

            var video = document.getElementById('modal-video');
            video.setAttribute('src', '');
            video.classList.add('hidden');
        }

        function clickShowVideo(div) {
            var video = document.getElementById('modal-video');
            video.setAttribute('src', '/resources/' + div.dataset.id);
            video.classList.remove('hidden');

            var image = document.getElementById('modal-image');
            image.setAttribute('src', '');
            image.classList.add('hidden');
        }

        function sendConnectState(socket) {

            var enterMsg =
                {
                    "type": "CONNECT",
                    "roomId": roomId,
                    "sender": username,
                };

            socket.send(JSON.stringify(enterMsg));
        }

        function readMessage(data) {
            var readCheck = document.getElementsByClassName('read-check');

            for (var i = 0; i < readCheck.length; i++) {
                var userNames = '';

                for(var j = 0; j < connectMember.length; j++)
                {
                    debugger;
                    userNames += connectMember[j];
                    if(j !== connectMember.length-1)
                    {
                        userNames += '님이, ';
                    }
                }

                readCheck.item(i).textContent = userNames + '님이 확인함';
            }
            scrollEnd();
        }

        function createMineMessage(data) {

            var readCheck = document.getElementsByClassName('read-check');

            for (var j = 0; j < readCheck.length; j++) {
                readCheck.item(j).textContent = '';
                readCheck.item(j).classList.remove('read-check');
            }

            var read = '';
            for (var i = 0; i < connectMember.length; i++) {
                read += connectMember[i] + '님';
                if (i !== connectMember.length - 1) {
                    read += ',';
                } else {
                    read += '이 확인함';
                }
            }

            var msgStr = '';
            var modal = '';
            var comment = '';


            if (data.dataType === 1) {
                msgStr =
                    '<div class="rounded-5 text-light" style="padding: 7px 12px; background: #3797F0; font-size: 15px">\n' +
                    data.msg +
                    '</div>\n';

                if (data.commented === 'true') {

                    var userText = '';
                    if (data.commentUsername === username) {
                        userText =
                            '            <div class="text-end mb-2" style="font-size: 12px; color: #797979; padding: 10px 8px 0 0">\n' +
                            '                회원님이 자신에게 보낸 답장\n' +
                            '            </div>\n';
                    } else {
                        userText =
                            '            <div class="text-end mb-2" style="font-size: 12px; color: #797979; padding: 10px 8px 0 0">\n' +
                            '회원님이 ' + data.commentUserText + '님에게 보낸 답장' +
                            '            </div>\n';
                    }

                    var commentContent = '';

                    if (data.commentDataType === 1) {
                        commentContent =
                            '                <div style="background:#efefef; font-size: 14px; padding: 8px 12px"\n' +
                            '                     class="rounded-5 mx-2">\n' +
                            data.commentContent +
                            '                </div>\n';
                    } else if (data.commentDataType === 2) {
                        commentContent =
                            '                <div onclick="clickShowImage(this)"\n' +
                            '                     data-id="' + data.commentContent + '"\n' +
                            '                     class="mx-2" type="button"\n' +
                            '                     data-bs-toggle="modal" data-bs-target="#showDataModal">\n' +
                            '                    <img src="/resources/' + data.commentContent + '"\n' +
                            '                         style="width: 10rem; height: auto; border-radius: 22px">\n' +
                            '                </div>\n';
                    } else if (data.commentDataType === 3) {
                        commentContent =
                            '                <div data-id="' + data.commentContent + '"\n' +
                            '                     onclick="clickShowVideo(this)"\n' +
                            '                     type="button"\n' +
                            '                     data-bs-toggle="modal" data-bs-target="#showDataModal"\n' +
                            '                     class="mx-2 d-flex justify-content-end position-relative">\n' +
                            '                    <span style="position: absolute;">\n' +
                            '                        <img height="45" width="45" alt=""\n' +
                            '                             src="/files/designImg/playButton.png">\n' +
                            '                    </span>\n' +
                            '                    <video style="width: 10rem; height: auto; border-radius: 22px"\n' +
                            '                           src="/resources/' + data.commentContent + '">\n' +
                            '                    </video>\n' +
                            '                </div>\n';
                    }
                    comment =
                        '   <div style="margin-right: 6px;  margin-bottom: 6px;">\n' +
                        userText +
                        '        <div>\n' +
                        '            <div class="d-flex justify-content-end">\n' +
                        commentContent +
                        '                <div style="background:#efefef; width: 4px; min-height: 34px">\n' +
                        '                </div>\n' +
                        '            </div>\n' +
                        '        </div>\n' +
                        '    </div>';
                }
            } else if (data.dataType === 2) {
                modal = ' data-id="' + data.msg + '"\n' +
                    ' onclick="clickShowImage(this)"' +
                    ' type="button" data-bs-toggle="modal" data-bs-target="#showDataModal"';
                msgStr =
                    '<div ' + modal + '>\n' +
                    '    <img src="/resources/' + data.msg + '" style="width: 15rem; height: auto; border-radius: 22px 4px 22px 22px">\n' +
                    '</div>';
            } else if (data.dataType === 3) {
                modal = ' data-id="' + data.msg + '"\n' +
                    ' onclick="clickShowVideo(this)"' +
                    ' type="button" data-bs-toggle="modal" data-bs-target="#showDataModal"';
                msgStr =
                    '<div class="d-flex justify-content-end position-relative" ' + modal + '>\n' +
                    '       <span style="position: absolute;">\n' +
                    '             <img height="45" width="45" alt="" src="/files/designImg/playButton.png">\n' +
                    '       </span>' +
                    '       <video style="width: 15rem; height: auto; border-radius: 22px 4px 22px 22px" src="/resources/' + data.msg + '">\n' +
                    '       </video>' +
                    '</div>';
            }


            let newMsg = document.createElement('div');
            newMsg.innerHTML =
                '                           <div id="msg' + data.id + '" style="margin-top: 7px;">\n' +
                '                                <div class="d-flex justify-content-end">\n' +
                '                                    <div>\n' +
                comment +
                '                                        <div class="d-flex align-items-center justify-content-end">\n' +
                '                                       <div class="d-flex align-items-center" style="margin-right: 5px">\n' +
                '                                            <div>\n' +
                '                                                <button id="' + data.id + '" data-user="true" data-type="' + data.dataType + '"  type="button" class="border-0" style="background: none; color: #9f9f9f" data-bs-container="body" data-bs-toggle="popover" data-bs-placement="top" data-bs-target="popover" data-bs-html="true">\n' +
                '                                                    <svg aria-label="더 보기" fill="currentColor" height="16" role="img" viewBox="0 0 24 24" width="16"><title>더 보기</title><circle cx="12" cy="12" r="1.5"></circle><circle cx="6" cy="12" r="1.5"></circle><circle cx="18" cy="12" r="1.5"></circle></svg>\n' +
                '                                                </button>\n' +
                '                                            </div>\n' +
                '                                            <div style="margin: 8px; color: #9f9f9f">\n' +
                '                                                <button id="' + data.id + '" data-user="true"\n' +
                '                                                  data-user-name=' + username + '\n' +
                '                                                  data-type="' + data.dataType + '"\n' +
                '                                                  data-msg-content="' + data.msg + '"' +
                '                                                  class="border-0" onclick="clickComment(this)"\n' +
                '                                                  style="background: none; color: #9f9f9f"\n' +
                '                                                  data-bs-container="body">\n' +
                '                                                    <svg aria-label="답장" fill="currentColor" height="16"\n' +
                '                                                       role="img" viewBox="0 0 24 24" width="16"><title>\n' +
                '                                                       답장</title>\n' +
                '                                                       <path d="M14 8.999H4.413l5.294-5.292a1 1 0 1 0-1.414-1.414l-7 6.998c-.014.014-.019.033-.032.048A.933.933 0 0 0 1 9.998V10c0 .027.013.05.015.076a.907.907 0 0 0 .282.634l6.996 6.998a1 1 0 0 0 1.414-1.414L4.415 11H14a7.008 7.008 0 0 1 7 7v3.006a1 1 0 0 0 2 0V18a9.01 9.01 0 0 0-9-9Z"></path>\n' +
                '                                                    </svg>\n' +
                '                                                 </button>\n' +
                '                                            </div>' +
                '                                            <div style="margin: 8px; color: #9f9f9f">\n' +
                '                                                <svg aria-label="공감" fill="currentColor" height="16" role="img" viewBox="0 0 24 24" width="16"><title>공감</title><path d="M15.83 10.997a1.167 1.167 0 1 0 1.167 1.167 1.167 1.167 0 0 0-1.167-1.167Zm-6.5 1.167a1.167 1.167 0 1 0-1.166 1.167 1.167 1.167 0 0 0 1.166-1.167Zm5.163 3.24a3.406 3.406 0 0 1-4.982.007 1 1 0 1 0-1.557 1.256 5.397 5.397 0 0 0 8.09 0 1 1 0 0 0-1.55-1.263ZM12 .503a11.5 11.5 0 1 0 11.5 11.5A11.513 11.513 0 0 0 12 .503Zm0 21a9.5 9.5 0 1 1 9.5-9.5 9.51 9.51 0 0 1-9.5 9.5Z"></path></svg>\n' +
                '                                            </div>\n' +
                '                                        </div>' +
                msgStr +
                '                                        </div>\n' +
                '                                        <div class="read-check text-end">\n' +
                read +
                '                                        </div>\n' +
                '                                    </div>\n' +
                '                                    <div style="width: 16px">\n' +
                '                                    </div>\n' +
                '                                </div>\n' +
                '                            </div>';

            msgArea.appendChild(newMsg);

            popoverChange();

            setTimeout(scrollEnd, 100);
        }

        function scrollEnd() {

            var objDiv = document.getElementById("msg-container");
            objDiv.scrollTop = objDiv.scrollHeight;
        }


        function createMessage(data) {

            let newMsg = document.createElement('div');

            var members = [[${nowRoomDTO.members}]];
            var imgSrc = '';
            var img = members[data.sender].image;
            if (img === null) {
                imgSrc = 'src="/files/designImg/noneuser.png"\n';
            } else {
                imgSrc = 'src="/resources/' + img.name + '"\n';
            }

            
            var userText =
                '                                <div style="margin-left: 44px; margin-top:10px; padding: 0 0 6px 12px; font-size: 12px; color: #797979">\n' +
                data.userText +
                '                                </div>\n';

            var msgStr = '';
            var align = '';
            var modal = '';
            var comment = '';
            if (data.dataType === 1) {

                msgStr =
                    '<div id="text' + data.id + '" class="rounded-5" style="background:#efefef; font-size: 15px; padding: 7px 12px;">' +
                    data.msg +
                    '</div>'

                align = 'align-items-center';

                if (data.commented === 'true') {
                    if (data.commentUsername === data.sender) {
                        userText =
                            '            <div class="mb-2" style="font-size: 12px; color: #797979; padding: 10px 0 0 8px">\n' +
                            '                ' + data.commentUserText + '님이 자신에게 보낸 답장\n' +
                            '            </div>\n';
                    } else {
                        var receive = '';
                        if(data.commentUsername === username)
                        {
                            receive = '회원';
                        }
                        else
                        {
                            receive = data.commentUserText;
                        }
                        userText =
                            '            <div class="mb-2" style="font-size: 12px; color: #797979; padding: 10px 0 0 8px">'
                            + data.userText + '님이 ' + receive +'님에게 보낸 답장' +
                            '            </div>\n';
                    }

                    
                    var commentContent = '';

                    if (data.commentDataType === 1) {
                        commentContent =
                            '                <div style="background:#efefef; font-size: 14px; padding: 8px 12px"\n' +
                            '                     class="rounded-5 mx-2">\n' +
                            data.commentContent +
                            '                </div>\n';
                    } else if (data.commentDataType === 2) {
                        commentContent =
                            '                <div onclick="clickShowImage(this)"\n' +
                            '                     data-id="' + data.commentContent + '"\n' +
                            '                     class="mx-2" type="button"\n' +
                            '                     data-bs-toggle="modal" data-bs-target="#showDataModal">\n' +
                            '                    <img src="/resources/' + data.commentContent + '"\n' +
                            '                         style="width: 10rem; height: auto; border-radius: 22px">\n' +
                            '                </div>\n';
                    } else if (data.commentDataType === 3) {
                        commentContent =
                            '                <div data-id="' + data.commentContent + '"\n' +
                            '                     onclick="clickShowVideo(this)"\n' +
                            '                     type="button"\n' +
                            '                     data-bs-toggle="modal" data-bs-target="#showDataModal"\n' +
                            '                     class="mx-2 d-flex justify-content-end position-relative">\n' +
                            '                    <span style="position: absolute;">\n' +
                            '                        <img height="45" width="45" alt=""\n' +
                            '                             src="/files/designImg/playButton.png">\n' +
                            '                    </span>\n' +
                            '                    <video style="width: 10rem; height: auto; border-radius: 22px"\n' +
                            '                           src="/resources/' + data.commentContent + '">\n' +
                            '                    </video>\n' +
                            '                </div>\n';
                    }
                    comment =
                        '   <div style="margin-right: 6px; margin-left: 44px; margin-bottom: 6px;">\n' +
                        userText +
                        '        <div>\n' +
                        '            <div class="d-flex">\n' +
                        '                <div style="background:#efefef; width: 4px; min-height: 34px">\n' +
                        '                </div>\n' +
                        commentContent +
                        '            </div>\n' +
                        '        </div>\n' +
                        '    </div>';
                    userText = '';
                }
            } else if (data.dataType === 2) {
                modal = ' data-id="' + data.msg + '"\n' +
                    ' onclick="clickShowImage(this)"' +
                    ' type="button" data-bs-toggle="modal" data-bs-target="#showDataModal"';
                msgStr =
                    '<div ' + modal + '>\n' +
                    '    <img src="/resources/' + data.msg + '" style="width: 15rem; height: auto; border-radius: 4px 22px 22px 22px">\n' +
                    '</div>';
            } else if (data.dataType === 3) {

                modal = ' data-id="' + data.msg + '"\n' +
                    ' onclick="clickShowVideo(this)"' +
                    ' type="button" data-bs-toggle="modal" data-bs-target="#showDataModal"';
                msgStr =
                    '<div class="d-flex justify-content-end position-relative" ' + modal + '>' +
                    '       <span style="position: absolute;">\n' +
                    '             <img height="45" width="45" alt="" src="/files/designImg/playButton.png">\n' +
                    '       </span>' +
                    '       <video style="width: 15rem; height: auto; border-radius: 4px 22px 22px 22px" src="/resources/' + data.msg + '">\n' +
                    '       </video>' +
                    '</div>';
            }

            newMsg.innerHTML =
                '                            <div id="msg' + data.id + '" style="margin-top: 7px;">\n' +
                userText +
                comment +
                '                                <div class="d-flex ' + align + '">\n' +
                '                                   <a href="/member/page/' + data.sender + '">\n' +
                '                                       <div style="position: relative; width: 28px; height: 28px; margin:0 8px 0 14px">\n' +
                '                                           <img ' + imgSrc +
                '                                               class="shadow-sm rounded-circle text-center"\n' +
                '                                               style="position: absolute; top: 0; left: 0; transform: translate(50,50); width: 100%; height: 100%; object-fit: cover; margin: auto">\n' +
                '                                       </div>\n' +
                '                                   </a>\n' +
                msgStr +
                '                                   <div class="d-flex align-items-center" style="margin-left: 5px">\n' +
                '                                            <div style="margin: 8px; color: #9f9f9f">\n' +
                '                                                <svg aria-label="공감" fill="currentColor" height="16" role="img" viewBox="0 0 24 24" width="16"><title>공감</title>\n' +
                '                                                    <path d="M15.83 10.997a1.167 1.167 0 1 0 1.167 1.167 1.167 1.167 0 0 0-1.167-1.167Zm-6.5 1.167a1.167 1.167 0 1 0-1.166 1.167 1.167 1.167 0 0 0 1.166-1.167Zm5.163 3.24a3.406 3.406 0 0 1-4.982.007 1 1 0 1 0-1.557 1.256 5.397 5.397 0 0 0 8.09 0 1 1 0 0 0-1.55-1.263ZM12 .503a11.5 11.5 0 1 0 11.5 11.5A11.513 11.513 0 0 0 12 .503Zm0 21a9.5 9.5 0 1 1 9.5-9.5 9.51 9.51 0 0 1-9.5 9.5Z"></path>\n' +
                '                                                </svg>\n' +
                '                                            </div>\n' +
                '                                            <div style="margin: 8px; color: #9f9f9f">\n' +
                '                                                <button id="' + data.id + '" data-user="false" data-user-name="' + data.sender + '" data-msg-content="' + data.msg + '" data-type="' + data.dataType + '" onclick="clickComment(this)" class="border-0" style="background: none; color: #9f9f9f" data-bs-container="body">\n' +
                '                                                    <svg aria-label="답장" fill="currentColor" height="16" role="img" viewBox="0 0 24 24" width="16"><title>답장</title>\n' +
                '                                                        <path d="M14 8.999H4.413l5.294-5.292a1 1 0 1 0-1.414-1.414l-7 6.998c-.014.014-.019.033-.032.048A.933.933 0 0 0 1 9.998V10c0 .027.013.05.015.076a.907.907 0 0 0 .282.634l6.996 6.998a1 1 0 0 0 1.414-1.414L4.415 11H14a7.008 7.008 0 0 1 7 7v3.006a1 1 0 0 0 2 0V18a9.01 9.01 0 0 0-9-9Z"></path>\n' +
                '                                                    </svg>\n' +
                '                                                </button>\n' +
                '                                            </div>\n' +
                '                                            <div>\n' +
                '                                                <button id="' + data.id + '" data-user="false" data-type="' + data.dataType + '" class="border-0" style="background: none; color: #9f9f9f" data-bs-container="body" data-bs-toggle="popover" data-bs-placement="top" data-bs-target="popover" data-bs-html="true" data-bs-original-title="" title="">\n' +
                '                                                    <svg aria-label="더 보기" fill="currentColor" height="16" role="img" viewBox="0 0 24 24" width="16"><title>더 보기</title>\n' +
                '                                                        <circle cx="12" cy="12" r="1.5"></circle>\n' +
                '                                                        <circle cx="6" cy="12" r="1.5"></circle>\n' +
                '                                                        <circle cx="18" cy="12" r="1.5"></circle>\n' +
                '                                                    </svg>\n' +
                '                                                </button>\n' +
                '                                            </div>\n' +
                '                                        </div>' +
                '                                   <div class="flex-fill">\n' +
                '                                    </div>\n' +
                '                                </div>\n' +
                '                            </div>';
            msgArea.appendChild(newMsg);

            setTimeout(scrollEnd, 100);
        }


        //메세지 보내기 버튼 눌렀을 떄..
        function sendMsg(btn) {

            var input = document.getElementById('msg-send-input');
            const csrfToken = document.querySelector('input[name="_csrf"]').value;
            var content = document.querySelector('.content');

            var area = document.getElementById('comment-msg-area');


            var talkMsg = {
                "type": "TALK",
                "roomId": roomId,
                "sender": username,
                "msg": content.value,
                "dataType": 1
            };

            if (input.dataset.type === 'msg') {

                fetch('/direct/message/create',
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRF-TOKEN': csrfToken
                        },
                        body: JSON.stringify(talkMsg)
                    })
                    .then(response => response.json())
                    .then(data => {
                        talkMsg.id = data.id;
                        talkMsg.userText = data.userText;

                        socket.send(JSON.stringify(talkMsg));
                    })
                    .catch(error => {
                        // 에러 처리
                        console.error('Error:', error);
                    });
            } else if (input.dataset.type === 'comment') {

                
                talkMsg.mapId = area.dataset.id;
                fetch('/direct/comment/create',
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRF-TOKEN': csrfToken
                        },
                        body: JSON.stringify(talkMsg)
                    })
                    .then(response => response.json())
                    .then(data => {
                        talkMsg.id = data.id;
                        talkMsg.commentContent = data.commentContent;
                        talkMsg.commentDataType = data.commentDataType;
                        talkMsg.commentUsername = data.commentUsername;
                        talkMsg.commentUserText = data.commentUserText;
                        talkMsg.commented = data.commented;
                        talkMsg.userText = data.userText;

                        socket.send(JSON.stringify(talkMsg));
                    })
                    .catch(error => {
                        // 에러 처리
                        console.error('Error:', error);
                    });
            }

            content.value = '';
            btn.disabled = true;
            closeCommentArea();
        }

        function quit() {
            sendDisconnectState(socket);

            const csrfToken = document.querySelector('input[name="_csrf"]').value;


            var quitMsg = {
                "type": "QUIT",
                "roomId": roomId,
                "sender": username
            };

            fetch('/direct/quit',
                {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': csrfToken
                    },
                    body: JSON.stringify(quitMsg)
                })

            socket.send(JSON.stringify(quitMsg));
            socket.close();
        }

        function sendDisconnectState(socket) {
            var enterMsg =
                {
                    "type": "DISCONNECT",
                    "roomId": roomId,
                    "sender": username,
                };

            socket.send(JSON.stringify(enterMsg));
        }

        window.addEventListener('beforeunload', function (e) {
            quit();
        });

        function clickFile() {
            var input = document.getElementById('file-sender');

            input.click();
        }

        function directFile(input) {
            if (input.files && input.files[0]) {
                sendImage(input);
            }
        }

        function sendImage(input) {

            const csrfToken = document.querySelector('input[name="_csrf"]').value;

            const formData = new FormData();
            for (const file of input.files) {
                formData.append('file-sender', file);
            }

            var talkMsg = {
                "type": "TALK",
                "roomId": roomId,
                "sender": username
            };

            formData.append('talkMsg', JSON.stringify(talkMsg));

            fetch('/direct/file/upload',
                {
                    method: 'POST',
                    headers: {
                        'X-CSRF-TOKEN': csrfToken
                    },
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    data.msg.forEach(msg => {
                            var imgMsg = {
                                "type": "TALK",
                                "roomId": data.roomId,
                                "sender": data.sender,
                                "dataType": msg.type,
                                "msg": msg.name,
                                "id": msg.id,
                                "userText": data.userText,
                            };

                            socket.send(JSON.stringify(imgMsg));
                        }
                    )
                })
                .catch(error => {
                    // 에러 처리
                    console.error('Error:', error);
                });
        }

        function deleteMsg(id, popID) {
            var res = confirm("전송을 취소하시겠습니까?");
            if (res) {
                fetch("/direct/delete/" + id)
                    .then(response => {
                            var msgContainer = document.getElementById('msg' + id);

                            msgContainer.remove();

                            var a = document.getElementById(popID);
                            a.remove();


                            var msg = {
                                "type": "DELETE",
                                "roomId": roomId,
                                "sender": username,
                                "id": id
                            };

                            socket.send(JSON.stringify(msg));
                        }
                    )
                    .catch(error => {
                        // 에러 처리
                        console.error('Error:', error);
                    });
            }
        }

        function resendMsg(id, popID) {

        }

        function copyMsg(id) {

            var divElement = document.getElementById('text' + id);

            var range = document.createRange();
            range.selectNode(divElement);

            var selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);

            document.execCommand('copy');
        }
    </script>
</div>
</html>